<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JAC ‚Äî Bono Especial | Tragamonedas</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --brand:#10b981; }
    body { font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial; background:#0b1220; color:#e2e8f0; }
    .card { background:linear-gradient(180deg,#0f172a 0%,#0b1324 100%); border:1px solid rgba(148,163,184,.18); border-radius:1.25rem; box-shadow:0 20px 50px rgba(0,0,0,.35); padding:1.25rem; }
    .btn { padding:0.9rem 1rem; border-radius:1rem; font-weight:800; letter-spacing:.3px; transition:transform .12s ease, filter .12s ease; }
    .btn:active { transform:scale(.98); }
    .btn-primary { background:linear-gradient(135deg, var(--brand), #34d399); color:#0b1220; box-shadow:0 12px 25px rgba(16,185,129,.35); }

    /* Slot */
    .slot-btn {
      width: 100%; aspect-ratio: 1/1; border-radius: 1rem;
      background: radial-gradient(circle at 30% 30%, #1f2937, #0b1220);
      border: 2px solid rgba(148,163,184,.35);
      box-shadow: inset 0 8px 18px rgba(255,255,255,.04), 0 12px 30px rgba(0,0,0,.35);
      display:flex; align-items:center; justify-content:center;
      transition: transform .12s ease, box-shadow .12s ease, border-color .2s ease, filter .25s ease;
      position:relative; overflow:hidden; cursor:pointer;
    }
    .slot-btn::after{
      content:""; position:absolute; inset:0; pointer-events:none;
      background: radial-gradient(220px 80px at 50% -10%, rgba(255,255,255,.12), transparent 60%);
    }
    .slot-btn:hover { transform: translateY(-3px) scale(1.05); border-color:#34d399; filter: brightness(1.2); }
    .slot-btn:disabled { opacity:.6; cursor:not-allowed; transform:none; filter: none; }

    .slot-label{
      font-size: clamp(1.6rem, 6.5vw, 3rem);
      font-weight: 900;
      letter-spacing: 0.08em;
      color:#fde047; /* amarillo */
      text-shadow: 0 2px 0 rgba(0,0,0,.35), 0 0 18px rgba(253,224,71,.18);
      user-select: none;
    }

    .slot-grid { display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap: .75rem; }
    .muted { font-size:.9rem; color:#94a3b8; }

    /* Suspenso */
    @keyframes suspense {
      0% { transform: translateY(0) scale(1); filter: brightness(1); }
      30%{ transform: translateY(-2px) scale(1.02) rotate(-1deg); filter: brightness(1.15); }
      60%{ transform: translateY(-1px) scale(1.04) rotate(1deg);  filter: brightness(1.05); }
      100%{ transform: translateY(0) scale(1); filter: brightness(1); }
    }
    .is-spinning { animation: suspense .4s ease-in-out infinite; border-color:#34d399; }

    /* Modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal{ width:min(92vw,520px); border-radius:1.25rem; background:linear-gradient(180deg,#0b1324,#0a1222); border:1px solid rgba(148,163,184,.22); box-shadow: 0 25px 60px rgba(0,0,0,.5); padding:1.25rem; text-align:center; }
    .modal h2{ font-size: clamp(2rem, 7vw, 3rem); font-weight:900; letter-spacing:.06em; text-shadow: 0 0 24px rgba(34,197,94,.25); }
    .modal p{ color:#cbd5e1; }
    .modal .close-btn{ margin-top:1rem; background:linear-gradient(135deg,#22c55e,#34d399); color:#0b1220; font-weight:800; border-radius:1rem; padding:.9rem 1.1rem; width:100%; }
    .modal .close-btn.secondary{ background:linear-gradient(135deg,#64748b,#94a3b8); color:#0b1220; }

    /* Contador */
    .pill {
      display:inline-flex; align-items:center; gap:.45rem;
      background:rgba(16,185,129,.12); border:1px solid rgba(16,185,129,.35);
      color:#a7f3d0; border-radius:.75rem; padding:.35rem .6rem; font-size:.85rem; font-weight:700;
    }
  </style>
</head>
<body>
  <main class="max-w-3xl mx-auto px-4 py-10">
    <section class="card space-y-6">
      <div class="text-center space-y-3">
        <img src="https://upload.wikimedia.org/wikipedia/commons/5/57/JAC_Motors_logo.svg" alt="JAC" class="h-10 mx-auto"
             onerror="this.replaceWith(Object.assign(document.createElement('div'),{textContent:'JAC',className:'text-2xl font-extrabold'}));" />
        <h1 class="text-3xl md:text-4xl font-extrabold">üé∞ Bono Especial JAC</h1>
        <p class="muted">Juega: 5 botones, 3 intentos. Solo algunos ganan‚Ä¶ ¬°suspenso total! üèÜ</p>
        <div class="pill mx-auto justify-center" id="counterWrap">üéÅ Bonos restantes: <span id="bonosLeft">‚Äî</span> / 100</div>
      </div>

      <!-- Controles -->
      <div class="grid md:grid-cols-3 gap-3 items-end">
        <button id="startBtn" class="btn btn-primary md:col-span-2">Empezar juego</button>
        <div class="text-center md:text-right">
          <div class="muted">Intentos restantes</div>
          <div id="tries" class="text-2xl font-extrabold">‚Äî</div>
        </div>
      </div>

      <!-- Juego -->
      <div id="gameWrap" class="hidden space-y-3">
        <p id="hint" class="muted">
          Uno de estos botones puede darte el bono. Tienes 3 intentos. Cada clic revela si te acercas‚Ä¶ o ¬°ganas!
        </p>
        <div class="slot-grid">
          <button class="slot-btn"><span class="slot-label">JAC</span></button>
          <button class="slot-btn"><span class="slot-label">JAC</span></button>
          <button class="slot-btn"><span class="slot-label">JAC</span></button>
          <button class="slot-btn"><span class="slot-label">JAC</span></button>
          <button class="slot-btn"><span class="slot-label">JAC</span></button>
        </div>
      </div>

      <div id="result" class="text-center text-lg font-semibold hidden"></div>
    </section>
  </main>

  <!-- Confeti -->
  <canvas id="confettiCanvas" class="fixed top-0 left-0 w-full h-full pointer-events-none"></canvas>

  <!-- Modal GANASTE -->
  <div id="winModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="winTitle">
    <div class="modal">
      <h2 id="winTitle" class="text-emerald-400">¬°GANASTE! üéâ</h2>
      <p class="mt-2">Has conseguido el bono. ¬°Felicidades!</p>
      <button class="close-btn" data-close="#winModal">Cerrar</button>
    </div>
  </div>

  <!-- Modal PERDISTE -->
  <div id="loseModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="loseTitle">
    <div class="modal">
      <h2 id="loseTitle" class="text-slate-200">Sigue participando üôå</h2>
      <p class="mt-2">Hoy no fue, pero todav√≠a puedes intentarlo m√°s tarde.</p>
      <button class="close-btn secondary" data-close="#loseModal">Entendido</button>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ------------------ Par√°metros de juego ------------------ */
  const WIN_RATE = 0.10;        // 10% de probabilidad de ganar
  const BONOS_TOTAL = 100;      // stock total (visual/local)
  const SPIN_DELAY_MS = 1200;   // suspenso antes de revelar
  const STORAGE_KEYS = {
    BONOS_LEFT: 'jac_bonos_left_v1',
    WON_FLAG: 'jac_won_flag_v1' // para evitar m√∫ltiples canjes locales
  };

  /* ------------------ Utilidades DOM ------------------ */
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const startBtn = $('#startBtn'), gameWrap = $('#gameWrap'), triesEl = $('#tries');
  const resultEl = $('#result'), hint = $('#hint');
  const bonosLeftEl = $('#bonosLeft');

  /* ------------------ Audio (Web Audio, sin archivos) ------------------ */
  let audioCtx;
  function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
  function tone(freq=440, dur=0.15, type='sine', vol=0.15){
    ensureAudio();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type=type; o.frequency.value=freq;
    g.gain.value=vol;
    o.connect(g).connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.05); }, dur*800);
    setTimeout(()=>{ o.stop(); }, dur*1000+60);
  }
  const sfx = {
    spinStart(){ tone(880, .12, 'triangle', .12); tone(1320, .12, 'triangle', .08); },
    spinTick(i){ tone(400+ i*20, .05, 'square', .06); },
    win(){ tone(523.25,.15,'sine',.18); setTimeout(()=>tone(659.25,.18,'sine',.18),140); setTimeout(()=>tone(783.99,.22,'sine',.18),300); },
    lose(){ tone(200,.18,'sawtooth',.12); setTimeout(()=>tone(160,.22,'sawtooth',.10),160); }
  };

  /* ------------------ Confetti ------------------ */
  const canvas = $('#confettiCanvas'), ctx = canvas.getContext('2d');
  function resizeCanvas(){ canvas.width = innerWidth; canvas.height = innerHeight; }
  addEventListener('resize', resizeCanvas); resizeCanvas();
  let confetti = [];
  function shootConfetti(){
    confetti = Array.from({length: 160}).map(() => ({
      x: Math.random()*canvas.width,
      y: Math.random()*-canvas.height,
      s: 4+Math.random()*6, v: 2+Math.random()*3,
      c: `hsl(${Math.random()*360},100%,50%)`, r: Math.random()*360
    }));
    animateConfetti();
  }
  function animateConfetti(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    confetti.forEach(p=>{
      p.y += p.v; p.r += p.v;
      if (p.y > canvas.height) p.y = -10;
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.r*Math.PI/180);
      ctx.fillStyle = p.c; ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s); ctx.restore();
    });
    if (confetti.length) requestAnimationFrame(animateConfetti);
  }

  /* ------------------ Modal ------------------ */
  function openModal(sel){ const m=$(sel); if(m) m.style.display='flex'; }
  function closeModal(sel){ const m=$(sel); if(m) m.style.display='none'; }
  $$('[data-close]').forEach(b=>{
    b.addEventListener('click',()=> closeModal(b.getAttribute('data-close')));
  });
  ['#winModal','#loseModal'].forEach(id=>{
    const el=$(id);
    el.addEventListener('click', e=>{ if(e.target===el) closeModal(id); });
  });
  document.addEventListener('keydown', e=>{
    if(e.key==='Escape'){ closeModal('#winModal'); closeModal('#loseModal'); }
  });

  /* ------------------ Bonos restantes (local/visual) ------------------ */
  function initBonos(){
    let left = localStorage.getItem(STORAGE_KEYS.BONOS_LEFT);
    if(left===null){
      left = String(BONOS_TOTAL);
      localStorage.setItem(STORAGE_KEYS.BONOS_LEFT, left);
    }
    bonosLeftEl.textContent = left;
  }
  function bonosLeft(){
    return parseInt(localStorage.getItem(STORAGE_KEYS.BONOS_LEFT) || `${BONOS_TOTAL}`, 10);
  }
  function decBonos(){
    const left = bonosLeft();
    const next = Math.max(0, left-1);
    localStorage.setItem(STORAGE_KEYS.BONOS_LEFT, String(next));
    bonosLeftEl.textContent = next;
  }

  // Hooks para backend futuro (global real):
  async function reportWin(){ /* POST a tu endpoint / firebase */ }
  async function fetchRemaining(){ /* GET a tu endpoint para actualizar bonosLeftEl */ }

  /* ------------------ L√≥gica de juego ------------------ */
  let triesLeft = 0, clicksMade = 0, locked = false;

  const slotButtons = $$('.slot-btn');
  slotButtons.forEach(btn => btn.addEventListener('click', ()=> onPick(btn)));

  function resetGameUI(){
    triesLeft = 3; clicksMade = 0; locked = false;
    triesEl.textContent = triesLeft;
    resultEl.textContent = '';
    resultEl.classList.add('hidden');
    slotButtons.forEach(b=>{ b.disabled = false; b.classList.remove('is-spinning'); });
    gameWrap.classList.remove('hidden');
    hint.textContent = 'Uno de estos botones puede darte el bono. Tienes 3 intentos. ¬°Suerte!';
  }

  startBtn.addEventListener('click', ()=>{
    ensureAudio();
    resetGameUI();
    gameWrap.scrollIntoView({behavior:'smooth', block:'center'});
  });

  function isWinner(){
    // No premios si ya no hay bonos
    if (bonosLeft() <= 0) return false;
    // Probabilidad base
    return Math.random() < WIN_RATE;
  }

  async function onPick(btn){
    if (triesLeft <= 0 || locked) return;

    // Bloqueo temporal para el ‚Äúsuspenso‚Äù
    locked = true;
    btn.classList.add('is-spinning');
    btn.disabled = true;
    sfx.spinStart();

    // ticks de ‚Äúruido‚Äù durante el suspenso
    let tickCount = 0;
    const tickTimer = setInterval(()=> sfx.spinTick(tickCount++), 150);

    setTimeout(async ()=>{
      clearInterval(tickTimer);
      btn.classList.remove('is-spinning');

      clicksMade += 1;
      triesLeft -= 1;
      triesEl.textContent = Math.max(0, triesLeft);

      if (clicksMade < 3){
        // Feedback intermedio (sin revelar a√∫n)
        resultEl.innerHTML = `üòÆ ¬°Casi! Se siente la suerte cerca‚Ä¶`;
        resultEl.classList.remove('hidden');
        locked = false;
        // Si se quedan en 0, dar una √∫ltima oportunidad (opcional)
        if (triesLeft === 0){ triesLeft = 1; triesEl.textContent = triesLeft; }
        return;
      }

      // Tercer clic: resultado real
      const youAlreadyWon = localStorage.getItem(STORAGE_KEYS.WON_FLAG) === 'yes';
      const win = !youAlreadyWon && isWinner();

      if (win){
        // Marca local, descuenta stock (local/visual), dispara efectos
        localStorage.setItem(STORAGE_KEYS.WON_FLAG,'yes');
        decBonos();
        sfx.win();
        resultEl.innerHTML = `üéâ <span class="text-emerald-400">¬°GANASTE EL BONO!</span>`;
        resultEl.classList.remove('hidden');
        shootConfetti();
        openModal('#winModal');
        try { await reportWin(); } catch(e){}
      } else {
        sfx.lose();
        resultEl.textContent = `üòî Esta vez no fue tu d√≠a. ¬°Vuelve a intentarlo m√°s tarde!`;
        resultEl.classList.remove('hidden');
        openModal('#loseModal');
      }

      // Fin de partida
      slotButtons.forEach(b=> b.disabled = true);
      locked = false;
    }, SPIN_DELAY_MS);
  }

  // Init
  initBonos();
});
</script>
</body>
</html>
