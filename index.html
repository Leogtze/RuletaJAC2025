<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
<title>Tragamonedas JAC ‚Äî V13 STUDIO CALCADO (Offline)</title>
<style>
  :root{
    --bg1:#090012; --bg2:#2a0750; --bg3:#0a031b;
    --gold:#ffd76a; --gold2:#ffb200; --cyan:#7df9ff; --magenta:#ff28d0; --violet:#8a3dff; --hot:#ff3b7a;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;height:100%;background:radial-gradient(160% 160% at 50% -20%, var(--bg2), var(--bg1) 40%, var(--bg3));color:#eee;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;overflow:hidden}
  body{display:flex}
  canvas{position:fixed;inset:0;width:100%;height:100%;z-index:1;touch-action:none;image-rendering:auto}
  .wrap{position:fixed;inset:0;z-index:3;display:flex;flex-direction:column;justify-content:space-between;padding:10px 12px calc(env(safe-area-inset-bottom,0) + 14px);pointer-events:none}
  header{display:flex;align-items:center;justify-content:space-between;gap:10px;pointer-events:auto}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:40px;height:40px;border-radius:14px;background:conic-gradient(from 0deg,var(--gold),#fff6b8,var(--gold2),var(--gold));box-shadow:0 0 18px rgba(255,215,106,.6), inset 0 0 12px rgba(0,0,0,.65);display:grid;place-items:center}
  .logo span{filter:drop-shadow(0 2px 2px rgba(0,0,0,.8));font-size:24px}
  h1{margin:0;font-size:18px;letter-spacing:1px;background:linear-gradient(90deg,#fff,var(--gold));-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 16px rgba(255,215,106,.4)}
  .hud{display:flex;align-items:center;gap:8px}
  .pill{font-weight:800;color:var(--gold);font-size:12px;padding:6px 10px;border-radius:999px;border:1.6px solid rgba(255,215,106,.8);background:rgba(255,215,106,.10);box-shadow:inset 0 0 12px rgba(255,215,106,.18)}
  .toggle{appearance:none;border:1.6px solid rgba(255,215,106,.8);background:rgba(0,0,0,.35);color:#fff;border-radius:999px;padding:6px 10px;font-size:12px;display:flex;align-items:center;gap:6px;cursor:pointer}
  .controls{display:flex;align-items:center;justify-content:center;margin-top:auto;pointer-events:auto}
  .btn{--size:118px;width:var(--size);height:var(--size);border-radius:999px;border:none;cursor:pointer;position:relative;display:grid;place-items:center;
    background:radial-gradient(120% 120% at 50% 0%, #4b0a99, #2a0a52 45%, #180634);
    box-shadow:0 26px 40px rgba(0,0,0,.82), inset 0 0 32px rgba(255,215,106,.26), 0 0 34px rgba(250,80,255,.45);
    border:2px solid rgba(255,215,106,.95); color:#fff; font-weight:900; letter-spacing:1px; text-transform:uppercase; font-size:18px}
  .btn span{position:relative;z-index:2;text-shadow:0 2px 0 rgba(0,0,0,.6),0 0 14px rgba(255,215,106,.55)}
  .btn::before{content:"";position:absolute;inset:-8px;border-radius:inherit;background:conic-gradient(from 0deg, rgba(255,215,106,.0), rgba(255,215,106,.85), rgba(255,215,106,.0));filter:blur(10px);animation:spinRing 2.2s linear infinite;opacity:.95}
  .btn:active{transform:translateY(1px) scale(.985)}
  .btn[disabled]{opacity:.55;filter:grayscale(.25);cursor:not-allowed}
  @keyframes spinRing{to{transform:rotate(1turn)}}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(5,3,12,.82);backdrop-filter:blur(5px);z-index:5}
  .modal.show{display:flex}
  .card{min-width:74%;max-width:520px;padding:24px 18px 18px;border-radius:24px;border:2px solid rgba(255,215,106,.98);background:radial-gradient(120% 140% at 50% 0%, rgba(255,255,255,.12), rgba(255,255,255,.05));box-shadow:0 24px 56px rgba(0,0,0,.9), inset 0 0 140px rgba(255,215,106,.18);text-align:center;position:relative;overflow:hidden}
  .card h2{margin:0 0 8px;background:linear-gradient(90deg,var(--gold),#fff,var(--gold));-webkit-background-clip:text;background-clip:text;color:transparent;font-size:30px;letter-spacing:1.6px}
  .card p{margin:0 0 16px;opacity:.96}
  .ok{margin-top:6px;padding:10px 20px;border-radius:999px;border:1.6px solid rgba(255,215,106,.95);background:rgba(0,0,0,.68);color:#fff;font-size:14px;cursor:pointer}
  .orient{position:fixed;inset:0;background:#070312;color:#eee;display:none;align-items:center;justify-content:center;z-index:6;text-align:center;padding:24px}
  .orient.show{display:flex}
</style>
</head>
<body>
<canvas id="stage" aria-label="M√°quina tragamonedas"></canvas>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo"><span>üöó</span></div>
      <h1>Tragamonedas JAC</h1>
    </div>
    <div class="hud">
      <div id="counter" class="pill" aria-live="polite">Tiradas restantes: 10</div>
      <button id="sound" class="toggle" aria-pressed="true"><span>üîä</span><span>Sonido</span></button>
    </div>
  </header>
  <div class="controls">
    <button id="spin" class="btn"><span>Girar</span></button>
  </div>
</div>
<div class="modal" id="win"><div class="card"><h2>¬°PREMIO!</h2><p>5 s√≠mbolos iguales en la l√≠nea central.</p><button class="ok" data-close="#win">Aceptar</button></div></div>
<div class="modal" id="jack"><div class="card"><h2>üéâ ¬°PREMIO MAYOR! üéâ</h2><p>Se activa el modo especial con 5 tiradas autom√°ticas culminando en 5 iguales.</p><button class="ok" data-close="#jack">Continuar</button></div></div>
<div class="orient" id="orient"><div><h3>Gira tu tel√©fono</h3><p>Este juego est√° optimizado para orientaci√≥n vertical.</p></div></div>

<script>
/* =========================================================
   V13 STUDIO CALCADO ‚Äî 1 archivo, sprites raster + FX
========================================================= */
const ROWS=3, COLS=5, PAYLINE=1, MAX_SPINS=10;
const JACKPOT_PROB=0.05, WIN_PROB=0.10;
const SYMS=['sedan','suv','pickup','volante','veloc','llaves','bateria','estrella','bono','test'];

const cvs = document.getElementById('stage'); const ctx = cvs.getContext('2d');
let W=innerWidth, H=innerHeight, DPR=window.devicePixelRatio||1;
function resize(){ W=innerWidth; H=innerHeight; DPR=window.devicePixelRatio||1; cvs.width=W*DPR; cvs.height=H*DPR; cvs.style.width=W+'px'; cvs.style.height=H+'px'; }
addEventListener('resize', resize); addEventListener('orientationchange', resize); resize();

function orientCheck(){ const land = matchMedia('(orientation: landscape)').matches; document.getElementById('orient').classList.toggle('show', land); }
addEventListener('resize', orientCheck); addEventListener('orientationchange', orientCheck); orientCheck();

let reel={x:0,y:0,w:0,h:0,cellH:0,cellW:0};
function layout(){ const w = Math.min(620, W*0.94); const h = Math.min(600, H*0.66); reel={ x:(W-w)/2, y:(H-h)/2-18, w, h, cellH:(h-22)/3, cellW:(w-44)/COLS }; }
layout();

/* =================== AUDIO =================== */
let audioOn=true, AC=null, master=null;
function ensureAudio(){ if(AC) return; const C=window.AudioContext||window.webkitAudioContext; if(!C) return; AC=new C(); master=AC.createGain(); master.gain.value=.95; master.connect(AC.destination); }
function layer(freqs,durs,types,vol=.22,offset=0){ if(!audioOn) return; ensureAudio(); if(!AC) return; const now=AC.currentTime+offset; freqs.forEach((f,i)=>{ const o=AC.createOscillator(), g=AC.createGain(); o.type=types[i]||'sine'; o.frequency.value=f; g.gain.value=0; o.connect(g).connect(master); const t0=now+i*0.01; g.gain.setValueAtTime(0,t0); g.gain.linearRampToValueAtTime(vol,t0+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t0+durs[i]); o.start(t0); o.stop(t0+durs[i]+.02); }); }
function whoosh(d=1.6){ if(!audioOn) return ()=>{}; ensureAudio(); if(!AC) return ()=>{}; const src=AC.createBufferSource(); const len=Math.floor(AC.sampleRate*d); const buf=AC.createBuffer(1,len,AC.sampleRate); const ch=buf.getChannelData(0); for(let i=0;i<len;i++){ const t=i/len; ch[i]=(Math.random()*2-1)*(1-t)*(0.7+0.3*Math.sin(i*0.002)); } src.buffer=buf; const bp=AC.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1600; bp.Q.value=1; const g=AC.createGain(); g.gain.value=.2; src.connect(bp).connect(g).connect(master); src.start(); return ()=>{try{src.stop()}catch(e){}} }
function playTick(i){ layer([260+i*60, 260+i*60*1.01],[.05,.03],['square','triangle'],.16) }
function playThunk(){ layer([110,55],[.10,.14],['triangle','sine'],.28) }
function jingleWin(){ const base=[880,1175,1760]; base.forEach((f,i)=>layer([f,f*1.5],[.14,.12],['triangle','square'],.30,i*0.12)) }
function jingleJack(){ const seq=[660,880,1320,1760,1320,880,660]; seq.forEach((f,i)=>layer([f,f*.75],[.18,.2],['square','sine'],.34,i*0.14)) }
function coinClinks(n=14){ for(let i=0;i<n;i++){ setTimeout(()=>layer([1400+Math.random()*700],[.06],['square'],.22),80*i) } }

/* =================== ATLAS RASTER A PARTIR DE SVG =================== */
const atlasCache = {}; // id@cellW x cellH -> canvas
function drawBevel(g,x,y,w,h,r){
  // metal base
  const grad = g.createLinearGradient(0,0,0,h);
  grad.addColorStop(0,'#fff5c9'); grad.addColorStop(.18,'#ffd76a'); grad.addColorStop(.42,'#8f5f00'); grad.addColorStop(.6,'#ffe39a'); grad.addColorStop(.78,'#b97d00'); grad.addColorStop(1,'#fff2b0');
  g.fillStyle=grad; roundRectPath(g,x,y,w,h,r); g.fill();
  // borde
  g.strokeStyle='#ffd76a'; g.lineWidth=3; roundRectPath(g,x,y,w,h,r); g.stroke();
  // glare
  const grd = g.createLinearGradient(x,y,x+w,y+h);
  grd.addColorStop(0,'rgba(255,255,255,.0)'); grd.addColorStop(.5,'rgba(255,255,255,.22)'); grd.addColorStop(1,'rgba(255,255,255,0)');
  g.globalCompositeOperation='lighter'; g.fillStyle=grd;
  g.beginPath(); g.moveTo(x,y+h*.12); g.lineTo(x+w,y); g.lineTo(x+w,y+h*.28); g.lineTo(x,y+h*.40); g.closePath(); g.fill();
  g.globalCompositeOperation='source-over';
}
function roundRectPath(g,x,y,w,h,r){
  g.beginPath(); g.moveTo(x+r,y); g.arcTo(x+w,y,x+w,y+h,r); g.arcTo(x+w,y+h,x,y+h,r); g.arcTo(x,y+h,x,y,r); g.arcTo(x,y,x+w,y,r); g.closePath();
}
function drawIcon(g, cx, cy, id){
  const G='#ffd76a';
  g.save();
  g.translate(cx, cy+4);
  g.lineWidth=5; g.strokeStyle=G; g.fillStyle=G;
  const poly=(arr)=>{ g.beginPath(); g.moveTo(arr[0],arr[1]); for(let i=2;i<arr.length;i+=2) g.lineTo(arr[i],arr[i+1]); g.closePath(); g.stroke(); }
  const circ=(x,y,r,fill)=>{ g.beginPath(); g.arc(x,y,r,0,Math.PI*2); fill? g.fill(): g.stroke(); }
  const line=(x1,y1,x2,y2)=>{ g.beginPath(); g.moveTo(x1,y1); g.lineTo(x2,y2); g.stroke(); }
  const rrect=(x,y,w,h,r,fill=false)=>{ roundRectPath(g,x-w/2,y-h/2,w,h,r); fill? g.fill(): g.stroke(); }
  switch(id){
    case 'sedan': poly([-70,20,70,20,50,-20,0,-45,-40,-45,-65,-20]); circ(-40,28,12,true); circ(40,28,12,true); break;
    case 'suv': poly([-72,22,72,22,58,-18,5,-45,-40,-45,-62,-18]); circ(-42,30,11,true); circ(42,30,11,true); break;
    case 'pickup': poly([-75,20,75,20,75,-18,25,-18,0,-45,-35,-45,-55,-18,-75,-18]); circ(-42,30,11,true); circ(42,30,11,true); break;
    case 'volante': circ(0,0,50,false); circ(0,0,20,true); g.lineWidth=4; line(-35,0,35,0); line(-15,-20,-55,-30); line(15,-20,55,-30); break;
    case 'veloc': circ(0,10,44,false); g.lineWidth=6; line(0,10,26,-16); break;
    case 'llaves': circ(-20,-10,22,false); g.lineWidth=5; line(0,10,60,60); line(60,60,74,46); line(74,46,86,58); break;
    case 'bateria': rrect(0,0,110,60,10,false); g.fillRect(56,-16,8,32); line(0,-26,-18,14); line(-18,14,6,14); line(6,14,-10,44); break;
    case 'estrella': g.beginPath(); for(let i=0;i<10;i++){ const ang=-Math.PI/2 + i*(Math.PI/5); const r=(i%2?18:36); const x=Math.cos(ang)*r, y=Math.sin(ang)*r; i? g.lineTo(x,y): g.moveTo(x,y); } g.closePath(); g.fill(); break;
    case 'bono': rrect(0,0,120,56,12,false); break;
    case 'test': rrect(0,0,120,80,12,false); line(-40,-5,40,-5); line(-40,18,10,18); circ(42,18,10,true); break;
  }
  g.restore();
}
function makeSymbolTexture(id, cellW, cellH){
  const padX=16, padY=10; const w=cellW-padX, h=cellH-padY;
  const c=document.createElement('canvas'); c.width=w*2; c.height=h*2; const g=c.getContext('2d'); g.scale(2,2);
  const r=Math.min(22,h*.2); drawBevel(g, 0,0,w,h,r); drawIcon(g, w/2, h/2, id);
  // resplandor
  g.globalCompositeOperation='lighter';
  const gg=g.createRadialGradient(w*.2,h*.2,10,w*.2,h*.2,w*.9); gg.addColorStop(0,'rgba(255,215,106,.14)'); gg.addColorStop(1,'rgba(255,215,106,0)');
  g.fillStyle=gg; g.beginPath(); g.arc(w*.2,h*.2,w*.9,0,Math.PI*2); g.fill();
  g.globalCompositeOperation='source-over';
  return c;
}
function getSymbol(id, cellW, cellH){
  const key=id+'@'+cellW+'x'+cellH;
  if(atlasCache[key]) return atlasCache[key];
  const tex=makeSymbolTexture(id, cellW, cellH);
  atlasCache[key]=tex; return tex;
}

/* =================== REELS =================== */
const columns = Array.from({length:COLS}, (_,i)=>({ y:0, target:0, delay:i*120, renderY:0, v:0 }));
function decideOutcome(){ const r=Math.random(); if(r<JACKPOT_PROB) return 'JACKPOT'; if(r<JACKPOT_PROB+WIN_PROB) return 'WIN'; return 'NORMAL'; }
function pickId(){ return SYMS[(Math.random()*SYMS.length)|0] }

/* =================== ANIMACI√ìN =================== */
const easeOutCubic = t => 1 - Math.pow(1-t,3);
const easeOutBack = t => { const c1=1.70158, c3=c1+1; return 1 + c3*Math.pow(t-1,3) + c1*Math.pow(t-1,2) };
function animateTo(col, to, dur, ease){ return new Promise(resolve=>{ const from=col.renderY||0; const t0=performance.now(); function step(ts){ const t=Math.min(1,(ts-t0)/dur); const prev=col.renderY; col.renderY = from + (to-from)*ease(t); col.v = col.renderY - prev; if(t<1) requestAnimationFrame(step); else resolve(); } requestAnimationFrame(step); }) }
async function spinTo(targetCenter){
  const stride = SYMS.length * reel.cellH;
  const base = 1420;
  const cleaners = whoosh(1.8);
  for(let i=0;i<COLS;i++){
    const col=columns[i];
    const chosen = targetCenter ? targetCenter[i] : pickId();
    const k = SYMS.indexOf(chosen);
    const loops = 6 + i;
    const dest = -(loops*stride + k*reel.cellH + PAYLINE*reel.cellH);
    await new Promise(r=>setTimeout(r, col.delay));
    // anticipaci√≥n
    col.renderY = col.renderY || -(Math.random()*stride);
    await animateTo(col, col.renderY - 24, 120, easeOutCubic);
    // giro con blur impl√≠cito en draw()
    await animateTo(col, dest+12, base+i*120, easeOutCubic);
    // bounce
    await animateTo(col, dest, 140, easeOutBack); playTick(i);
    if(i===COLS-1){ playThunk(); cleaners && cleaners(); }
  }
}

/* =================== PART√çCULAS + FX =================== */
const particles=[];
function spawnCoins(x,y,w){ for(let i=0;i<140;i++) particles.push({type:'coin',x:x+Math.random()*w,y:y-24-Math.random()*40, vx:(Math.random()*2-1)*1.5, vy:1+Math.random()*2.5, rot:Math.random()*Math.PI*2, vr:(Math.random()-.5)*.26, life:150+Math.random()*70}); }
function spawnConfetti(x,y,w){ for(let i=0;i<160;i++) particles.push({type:'conf',x:x+Math.random()*w,y:y-24-Math.random()*40, vx:(Math.random()*2-1)*1.7, vy:1+Math.random()*3.0, rot:Math.random()*Math.PI*2, vr:(Math.random()-.5)*.34, life:150+Math.random()*70}); }
function drawParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.vy*=1.012; p.rot+=p.vr; p.life--;
    if(p.type==='coin'){
      ctx.save(); ctx.translate(p.x*DPR,p.y*DPR); ctx.rotate(p.rot);
      const r=8*DPR; const grd=ctx.createRadialGradient(-r*.2,-r*.2, r*.2, 0,0,r);
      grd.addColorStop(0,'#fff'); grd.addColorStop(.5,'#ffd76a'); grd.addColorStop(1,'#b57b00');
      ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill(); ctx.restore();
    } else {
      ctx.save(); ctx.translate(p.x*DPR,p.y*DPR); ctx.rotate(p.rot);
      ctx.fillStyle='rgba(255,40,208,.9)'; ctx.fillRect(-3*DPR,-5*DPR,6*DPR,10*DPR); ctx.restore();
    }
    if(p.life<=0) particles.splice(i,1);
  }
}

/* =================== HUD FX =================== */
let payFlash=0; function triggerPayFlash(){ payFlash=1; }
let ledPhase=0;
function drawPayline(){
  for(let i=3;i>=1;i--){ ctx.strokeStyle=`rgba(125,249,255,${.12*i + (payFlash*0.35)})`; ctx.lineWidth=i+1; line(reel.x+12, reel.y + reel.cellH*PAYLINE + 10, reel.x+reel.w-12, reel.y + reel.cellH*PAYLINE + 10); }
  payFlash *= .85;
}
function drawLEDs(){
  const step=16, r=3.2*DPR;
  for(let x=reel.x-10; x<reel.x+reel.w+10; x+=step){
    const t=((x+ledPhase)/step)%1; const a=.25+.75*Math.max(0,Math.cos(t*Math.PI*2));
    dot(x, reel.y-14, r, a);
    dot(x, reel.y+reel.h+14, r, a*.85);
  }
  for(let y=reel.y-10; y<reel.y+reel.h+10; y+=step){
    const t=((y+ledPhase)/step)%1; const a=.25+.75*Math.max(0,Math.cos(t*Math.PI*2));
    dot(reel.x-14, y, r, a*.9);
    dot(reel.x+reel.w+14, y, r, a*.9);
  }
  ledPhase += 0.9;
}
function dot(x,y,r,a){
  ctx.save(); ctx.translate(x*DPR,y*DPR);
  const g=ctx.createRadialGradient(0,0,0,0,0,r*2.2); g.addColorStop(0,`rgba(255,215,106,${.7*a})`); g.addColorStop(1,'rgba(255,215,106,0)');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,r*2.2,0,Math.PI*2); ctx.fill();
  ctx.fillStyle=`rgba(255,215,106,${.9*a})`; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
  ctx.restore();
}

/* =================== HELPERS =================== */
function line(x1,y1,x2,y2){ ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); }
function roundRect(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
function radial(x,y,r,fill){ ctx.save(); ctx.translate(x*DPR,y*DPR); const g=ctx.createRadialGradient(0,0,0,0,0,r*DPR); g.addColorStop(0,fill); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,r*DPR,0,Math.PI*2); ctx.fill(); ctx.restore(); }

/* =================== DRAW LOOP =================== */
let winCount=0, winCountTarget=0;
function draw(){
  ctx.setTransform(DPR,0,0,DPR,0,0);
  ctx.clearRect(0,0,W,H);
  // fondo
  radial(W*0.2,H*0.25,360,'rgba(255,40,208,.10)'); radial(W*0.8,H*0.35,420,'rgba(138,61,255,.10)');
  // marco
  ctx.save();
  ctx.strokeStyle='#ffd76a'; ctx.lineWidth=6; roundRect(reel.x-20,reel.y-20,reel.w+40,reel.h+40,30); ctx.stroke();
  ctx.globalAlpha=.9; ctx.strokeStyle='rgba(255,255,255,.08)'; ctx.lineWidth=3; roundRect(reel.x,reel.y,reel.w,reel.h,24); ctx.stroke();
  ctx.restore();
  drawLEDs();
  drawPayline();
  // ventana
  ctx.save(); roundRect(reel.x,reel.y,reel.w,reel.h,24); ctx.clip();
  for(let c=0;c<COLS;c++){
    const col=columns[c];
    const baseX = reel.x + c*(reel.w/COLS);
    const yOffset = col.renderY ?? col.y;
    const blurSamples = Math.min(6, Math.max(1, Math.ceil(Math.abs(col.v)/3)));
    for(let s=0;s<blurSamples;s++){
      const lerp = s/(blurSamples-1||1);
      const yL = yOffset - col.v*lerp*0.5;
      const alpha = 1 - lerp*0.85;
      ctx.globalAlpha = alpha;
      const startY = Math.floor((-yL - reel.cellH*2)/reel.cellH)*reel.cellH;
      for(let y=startY; y<(-yL + reel.h + reel.cellH*2); y+=reel.cellH){
        const rowIndex = Math.floor((y/reel.cellH) % SYMS.length); const id = SYMS[(rowIndex+SYMS.length)%SYMS.length];
        const tex = getSymbol(id, reel.cellW, reel.cellH);
        ctx.drawImage(tex, Math.round(baseX+8), Math.round(y + yL + reel.y + 10), Math.round(reel.cellW-16), Math.round(reel.cellH-8));
      }
    }
    ctx.globalAlpha = 1;
    if(Math.abs(col.v)<0.4){
      const sy = reel.y + reel.cellH*PAYLINE + 10;
      const sx = (Date.now()/4 + c*160) % (reel.cellW);
      const grd=ctx.createLinearGradient(baseX+sx-80,sy, baseX+sx+80, sy+reel.cellH-8);
      grd.addColorStop(0,'rgba(255,255,255,0)'); grd.addColorStop(.5,'rgba(255,255,255,.18)'); grd.addColorStop(1,'rgba(255,255,255,0)');
      ctx.fillStyle=grd; ctx.fillRect(baseX+8, sy, reel.cellW-16, reel.cellH-8);
    }
  }
  ctx.restore();
  drawParticles();
  if(winCount < winCountTarget){ winCount += Math.max(1, Math.floor((winCountTarget-winCount)*0.12)); }
  if(winCount>0){
    ctx.save(); ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font=`700 ${Math.max(18, Math.min(42, W*0.08))}px system-ui`; ctx.fillStyle='rgba(255,215,106,.95)';
    ctx.shadowColor='rgba(255,215,106,.7)'; ctx.shadowBlur=18;
    ctx.fillText(`Premio: ${winCount}`, W/2, reel.y - 28);
    ctx.restore();
  }
  requestAnimationFrame(draw);
}
requestAnimationFrame(draw);

/* =================== JUEGO =================== */
const btn=document.getElementById('spin'); const toggleSound=document.getElementById('sound'); const modalWin=document.getElementById('win'); const modalJack=document.getElementById('jack');
function show(m){ m.classList.add('show') } function hide(m){ m.classList.remove('show') }
document.querySelectorAll('[data-close]').forEach(b=> b.addEventListener('click', e=>{ const sel=e.currentTarget.getAttribute('data-close'); const m=document.querySelector(sel); if(m) hide(m) }));
function vibrate(p){ if(navigator.vibrate) navigator.vibrate(p) }

let spinsLeft=MAX_SPINS, spinning=false, inJackpot=false;
const counterEl=document.getElementById('counter'); function updateCounter(){ counterEl.textContent=`Tiradas restantes: ${spinsLeft}` } updateCounter();

async function doSpin(manual=true){
  if(spinning) return;
  if(manual){ if(spinsLeft<=0) return; ensureAudio(); spinsLeft--; updateCounter(); }
  spinning=true; btn.disabled=true;
  let outcome='NORMAL'; if(manual && !inJackpot) outcome = decideOutcome();
  if(outcome==='JACKPOT' && !inJackpot){
    inJackpot=true; jingleJack(); show(modalJack); vibrate([80,40,120]); setTimeout(()=>hide(modalJack),900);
    for(let i=1;i<=5;i++){
      let target=null;
      if(i===5){ const id=pickId(); target=Array(COLS).fill(id) }
      else { const id=pickId(); const same=2 + (Math.random()*2|0); target=Array(COLS).fill(null).map((_,k)=> k<same? id : pickId()) }
      const cleaners = whoosh(1.3 + i*0.1);
      await spinTo(target);
      if(i<5) coinClinks(6+i*2);
      await new Promise(r=>setTimeout(r, 120 + i*70));
    }
    jingleJack(); coinClinks(24); spawnCoins(reel.x, reel.y, reel.w); triggerPayFlash(); vibrate(220);
    winCountTarget += 100;
    show(modalJack);
    inJackpot=false; spinning=false; btn.disabled = spinsLeft<=0; return;
  }
  let target=null; if(outcome==='WIN'){ const id=pickId(); target=Array(COLS).fill(id) }
  await spinTo(target);
  if(outcome==='WIN'){ jingleWin(); spawnConfetti(reel.x, reel.y, reel.w); triggerPayFlash(); vibrate([60,40,60]); winCountTarget += 25; show(modalWin); }
  spinning=false; btn.disabled = spinsLeft<=0;
}

/* Eventos UI */
btn.addEventListener('click', ()=>doSpin(true));
toggleSound.addEventListener('click', ()=>{
  audioOn=!audioOn; toggleSound.setAttribute('aria-pressed', audioOn?'true':'false');
  toggleSound.innerHTML = audioOn? '<span>üîä</span><span>Sonido</span>' : '<span>üîá</span><span>Silencio</span>';
  if(audioOn){ ensureAudio(); layer([880,1320],[.08,.12],['triangle','square'],.28) }
});

/* Touch UX */
document.addEventListener('touchmove', (e)=>{ if(e.touches.length===1) e.preventDefault() }, {passive:false});
</script>
</body>
</html>
