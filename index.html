<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
<title>Tragamonedas JAC â€” PRO</title>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<style>
  :root{
    --bg1:#090012; --bg2:#2a0750; --bg3:#0a031b;
    --gold:#ffd76a; --gold2:#ffb200; --cyan:#7df9ff; --magenta:#ff28d0; --violet:#8a3dff; --hot:#ff3b7a;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;height:100%;background:radial-gradient(160% 160% at 50% -20%, var(--bg2), var(--bg1) 40%, var(--bg3));color:#eee;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;overflow:hidden}
  body{display:flex}

  /* UI Overlay */
  .wrap{position:fixed;inset:0;z-index:3;display:flex;flex-direction:column;justify-content:space-between;padding:10px 12px calc(env(safe-area-inset-bottom,0) + 14px);pointer-events:none}
  header{display:flex;align-items:center;justify-content:space-between;gap:10px;pointer-events:auto}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:40px;height:40px;border-radius:14px;background:conic-gradient(from 0deg,var(--gold),#fff6b8,var(--gold2),var(--gold));box-shadow:0 0 18px rgba(255,215,106,.6), inset 0 0 12px rgba(0,0,0,.65);display:grid;place-items:center}
  .logo span{filter:drop-shadow(0 2px 2px rgba(0,0,0,.8));font-size:24px}
  h1{margin:0;font-size:18px;letter-spacing:1px;background:linear-gradient(90deg,#fff,var(--gold));-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 16px rgba(255,215,106,.4)}
  .hud{display:flex;align-items:center;gap:8px}
  .pill{font-weight:800;color:var(--gold);font-size:12px;padding:6px 10px;border-radius:999px;border:1.6px solid rgba(255,215,106,.8);background:rgba(255,215,106,.10);box-shadow:inset 0 0 12px rgba(255,215,106,.18)}
  .toggle{appearance:none;border:1.6px solid rgba(255,215,106,.8);background:rgba(0,0,0,.35);color:#fff;border-radius:999px;padding:6px 10px;font-size:12px;display:flex;align-items:center;gap:6px;cursor:pointer}

  .controls{display:flex;align-items:center;justify-content:center;margin-top:auto;pointer-events:auto}
  .btn{--size:114px;width:var(--size);height:var(--size);border-radius:999px;border:none;cursor:pointer;position:relative;display:grid;place-items:center;
    background:radial-gradient(120% 120% at 50% 0%, #4b0a99, #2a0a52 45%, #180634);
    box-shadow:0 26px 40px rgba(0,0,0,.82), inset 0 0 32px rgba(255,215,106,.26), 0 0 34px rgba(250,80,255,.45);
    border:2px solid rgba(255,215,106,.95); color:#fff; font-weight:900; letter-spacing:1px; text-transform:uppercase; font-size:18px}
  .btn span{position:relative;z-index:2;text-shadow:0 2px 0 rgba(0,0,0,.6),0 0 14px rgba(255,215,106,.55)}
  .btn::before{content:"";position:absolute;inset:-8px;border-radius:inherit;background:conic-gradient(from 0deg, rgba(255,215,106,.0), rgba(255,215,106,.85), rgba(255,215,106,.0));filter:blur(10px);animation:spinRing 2.2s linear infinite;opacity:.95}
  .btn:active{transform:translateY(1px) scale(.985)}
  .btn[disabled]{opacity:.55;filter:grayscale(.25);cursor:not-allowed}
  @keyframes spinRing{to{transform:rotate(1turn)}}

  canvas{position:fixed;inset:0;width:100%;height:100%;z-index:1}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(5,3,12,.82);backdrop-filter:blur(5px);z-index:5}
  .modal.show{display:flex}
  .card{min-width:74%;max-width:520px;padding:24px 18px 18px;border-radius:24px;border:2px solid rgba(255,215,106,.98);background:radial-gradient(120% 140% at 50% 0%, rgba(255,255,255,.12), rgba(255,255,255,.05));box-shadow:0 24px 56px rgba(0,0,0,.9), inset 0 0 140px rgba(255,215,106,.18);text-align:center;position:relative;overflow:hidden}
  .card h2{margin:0 0 8px;background:linear-gradient(90deg,var(--gold),#fff,var(--gold));-webkit-background-clip:text;background-clip:text;color:transparent;font-size:30px;letter-spacing:1.6px}
  .card p{margin:0 0 16px;opacity:.96}
  .ok{margin-top:6px;padding:10px 20px;border-radius:999px;border:1.6px solid rgba(255,215,106,.95);background:rgba(0,0,0,.68);color:#fff;font-size:14px;cursor:pointer}

  .orient{position:fixed;inset:0;background:#070312;color:#eee;display:none;align-items:center;justify-content:center;z-index:6;text-align:center;padding:24px}
  .orient.show{display:flex}
</style>
</head>
<body>
<canvas id="stage" aria-label="MÃ¡quina tragamonedas"></canvas>

<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo"><span>ðŸš—</span></div>
      <h1>Tragamonedas JAC</h1>
    </div>
    <div class="hud">
      <div id="counter" class="pill" aria-live="polite">Tiradas restantes: 10</div>
      <button id="sound" class="toggle" aria-pressed="true"><span>ðŸ”Š</span><span>Sonido</span></button>
    </div>
  </header>

  <div class="controls">
    <button id="spin" class="btn"><span>Girar</span></button>
  </div>
</div>

<!-- PREMIO -->
<div class="modal" id="win">
  <div class="card">
    <h2>Â¡PREMIO!</h2>
    <p>5 sÃ­mbolos iguales en la lÃ­nea central.</p>
    <button class="ok" data-close="#win">Aceptar</button>
  </div>
</div>

<!-- PREMIO MAYOR -->
<div class="modal" id="jack">
  <div class="card">
    <h2>ðŸŽ‰ Â¡PREMIO MAYOR! ðŸŽ‰</h2>
    <p>Se activa el modo especial con 5 tiradas automÃ¡ticas culminando en 5 iguales.</p>
    <button class="ok" data-close="#jack">Continuar</button>
  </div>
</div>

<div class="orient" id="orient">
  <div>
    <h3>Gira tu telÃ©fono</h3>
    <p>Este juego estÃ¡ optimizado para orientaciÃ³n vertical.</p>
  </div>
</div>

<!-- PIXI.js & Filters -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.3/pixi.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi-filters/5.3.1/pixi-filters.min.js" crossorigin="anonymous"></script>
<script>
/* =========================================================
   ParÃ¡metros base
========================================================= */
const ROWS=3, COLS=5, MAX_SPINS=10, PAYLINE=1;
const JACKPOT_PROB=0.05, WIN_PROB=0.10;
const SYM_IDS = ['sedan','suv','pickup','vol','velo','key','bat','star','bono','test'];

/* =========================================================
   App & escena
========================================================= */
const app = new PIXI.Application({ view: document.getElementById('stage'), resizeTo: window, antialias: true, backgroundAlpha: 0 });
const stage = app.stage;
let W=innerWidth, H=innerHeight;
function layout(){
  W=innerWidth; H=innerHeight;
  const isLand = matchMedia('(orientation: landscape)').matches;
  document.getElementById('orient').classList.toggle('show', isLand);
}
addEventListener('resize', layout); addEventListener('orientationchange', layout); layout();

/* Fondo con partÃ­culas suaves */
const back = new PIXI.Container(); stage.addChild(back);
const bgGlow = new PIXI.Graphics(); bgGlow.beginFill(0xff28d0, .08).drawCircle(0,0, 360).endFill(); bgGlow.x=W*0.2; bgGlow.y=H*0.25;
const bgGlow2 = new PIXI.Graphics(); bgGlow2.beginFill(0x8a3dff, .08).drawCircle(0,0, 420).endFill(); bgGlow2.x=W*0.8; bgGlow2.y=H*0.35;
back.addChild(bgGlow,bgGlow2);

/* =========================================================
   GeneraciÃ³n de texturas de sÃ­mbolos (vectoriales)
========================================================= */
function makeSymbolTexture(id, cellW, cellH){
  const cont = new PIXI.Container();
  const card = new PIXI.Graphics();
  card.beginFill(0xffffff, 0.08).drawRoundedRect(0,0, cellW, cellH, Math.min(22, cellH*0.2)).endFill();
  const border = new PIXI.Graphics();
  border.lineStyle(4, 0xffd76a, 1).drawRoundedRect(0,0, cellW, cellH, Math.min(22, cellH*0.2));
  const bevel = new PIXI.Graphics();
  bevel.beginFill(0xffd76a, .18).drawRoundedRect(6,6, cellW-12, cellH-12, Math.min(18, cellH*0.16)).endFill();
  cont.addChild(card, bevel, border);

  const icon = new PIXI.Graphics();
  icon.x = cellW/2; icon.y = cellH/2;
  const G=0xffd76a;
  switch(id){
    case 'sedan':
      icon.lineStyle(5, G, 1).drawPolygon([-70,20,70,20,50,-20,0,-45,-40,-45,-65,-20]);
      icon.beginFill(G).drawCircle(-40,28,12).drawCircle(40,28,12).endFill();
      break;
    case 'suv':
      icon.lineStyle(5, G, 1).drawPolygon([-72,22,72,22,58,-18,5,-45,-40,-45,-62,-18]);
      icon.beginFill(G).drawCircle(-42,30,11).drawCircle(42,30,11).endFill();
      break;
    case 'pickup':
      icon.lineStyle(5, G, 1).drawPolygon([-75,20,75,20,75,-18,25,-18,0,-45,-35,-45,-55,-18,-75,-18]);
      icon.beginFill(G).drawCircle(-42,30,11).drawCircle(42,30,11).endFill();
      break;
    case 'vol':
      icon.lineStyle(5, G, 1).drawCircle(0,0,50); icon.beginFill(G).drawCircle(0,0,20).endFill();
      icon.lineStyle(4, G,1).moveTo(-35,0).lineTo(35,0).moveTo(-15,-20).lineTo(-55,-30).moveTo(15,-20).lineTo(55,-30);
      break;
    case 'velo':
      icon.lineStyle(5, G, 1).drawCircle(0,10,44); icon.lineStyle(6, G, 1).moveTo(0,10).lineTo(26,-16);
      break;
    case 'key':
      icon.lineStyle(5, G, 1).drawCircle(-20,-10,22);
      icon.lineStyle(5, G, 1).moveTo(0,10).lineTo(60,60).moveTo(60,60).lineTo(74,46).moveTo(74,46).lineTo(86,58);
      break;
    case 'bat':
      icon.lineStyle(5, G, 1).drawRoundedRect(-55,-30,110,60,10);
      icon.beginFill(G).drawRect(56,-16,8,32).endFill();
      icon.lineStyle(5, G, 1).moveTo(0,-26).lineTo(-18,14).moveTo(-18,14).lineTo(6,14).moveTo(6,14).lineTo(-10,44);
      break;
    case 'star':
      icon.beginFill(G,1); icon.drawStar(0,0,5,36,18).endFill();
      icon.lineStyle(3, G, .9).drawStar(0,0,5,36,18);
      break;
    case 'bono':
      icon.lineStyle(5, G, 1).drawRoundedRect(-60,-28,120,56,12);
      break;
    case 'test':
      icon.lineStyle(5, G, 1).drawRoundedRect(-60,-40,120,80,12);
      icon.lineStyle(5, G, 1).moveTo(-40,-5).lineTo(40,-5).moveTo(-40,18).lineTo(10,18);
      icon.beginFill(G).drawCircle(42,18,10).endFill();
      break;
  }
  cont.addChild(icon);
  return app.renderer.generateTexture(cont, {resolution: window.devicePixelRatio||1});
}

/* =========================================================
   Reels + filtros pro
========================================================= */
let reelRect={x:0,y:0,w:0,h:0,cellH:0,cellW:0};
function computeReelRect(){
  const w = Math.min(600, W*0.94);
  const h = Math.min(560, H*0.64);
  reelRect = { x:(W-w)/2, y:(H-h)/2-20, w, h, cellH:(h-20)/3, cellW:(w-40)/COLS };
}
computeReelRect();

const reelsCont = new PIXI.Container(); stage.addChild(reelsCont);
const bezel = new PIXI.Graphics(); reelsCont.addChild(bezel);
const mask = new PIXI.Graphics(); reelsCont.addChild(mask);
const payline = new PIXI.Graphics(); reelsCont.addChild(payline);
const columns=[]; // {strip:Container, sprites:[Sprite], y:number}

function drawBezel(){
  bezel.clear();
  // marco exterior
  bezel.lineStyle(6, 0xffd76a, 1).beginFill(0x0, .15).drawRoundedRect(reelRect.x-14, reelRect.y-14, reelRect.w+28, reelRect.h+28, 30).endFill();
  // caja
  bezel.lineStyle(3, 0xffffff, .08).beginFill(0x000000, .35).drawRoundedRect(reelRect.x, reelRect.y, reelRect.w, reelRect.h, 24).endFill();
}
function drawMask(){
  mask.clear();
  mask.beginFill(0xffffff,1).drawRoundedRect(reelRect.x, reelRect.y, reelRect.w, reelRect.h, 24).endFill();
  reelsCont.mask = mask;
}
function drawPayline(){
  payline.clear();
  // lÃ­nea con glow simulada por varias pasadas
  for(let i=0;i<3;i++){
    payline.lineStyle(2+i, 0x7df9ff, 0.3 - i*0.05);
    payline.moveTo(reelRect.x+12, reelRect.y + reelRect.cellH*PAYLINE + 10);
    payline.lineTo(reelRect.x + reelRect.w - 12, reelRect.y + reelRect.cellH*PAYLINE + 10);
  }
}

const bloom = new PIXI.filters.AdvancedBloomFilter({threshold:.4, bloomScale:1.2, brightness:.9, blur:2});
const kawase = new PIXI.filters.KawaseBlurFilter([2,3], 4, true);
const godray = new PIXI.filters.GodrayFilter({ parallel:false, lacunarity:1.5, gain:.5, angle:30, time:0 });
reelsCont.filters = [bloom, kawase];

function buildColumns(){
  columns.length=0;
  reelsCont.removeChildren(); reelsCont.addChild(bezel); reelsCont.addChild(mask); reelsCont.addChild(payline);
  const repeats=10;
  for(let c=0;c<COLS;c++){
    const col = new PIXI.Container();
    col.x = reelRect.x + c*(reelRect.w/COLS);
    col.y = reelRect.y;
    reelsCont.addChild(col);
    const strip = new PIXI.Container(); col.addChild(strip);
    let y=10;
    const sprites=[];
    for(let r=0;r<repeats;r++){
      for(const id of SYM_IDS){
        const tex = makeSymbolTexture(id, reelRect.cellW, reelRect.cellH-6);
        const sp = new PIXI.Sprite(tex);
        sp.anchor.set(.5);
        sp.x = reelRect.cellW/2;
        sp.y = y + reelRect.cellH/2;
        sp.filters = [new PIXI.filters.BlurFilter(0.5)];
        strip.addChild(sp); sprites.push(sp);
        y += reelRect.cellH;
      }
    }
    columns.push({col, strip, sprites, y:0});
  }
  drawBezel(); drawMask(); drawPayline();
}
buildColumns();

/* LED flicker */
app.ticker.add((delta)=>{
  const t = app.ticker.lastTime/1000;
  bloom.brightness = 0.85 + Math.sin(t*2.4)*0.04;
  godray.time += 0.005*delta;
});

/* =========================================================
   Audio: WebAudio + samples embebidos
========================================================= */
let audioOn=true, AC=null, master=null;
function ensureAudio(){ if(AC) return; const C = window.AudioContext||window.webkitAudioContext; if(!C) return; AC=new C(); master=AC.createGain(); master.gain.value=.95; master.connect(AC.destination) }
function tone(f=440,d=.1,type='sine',v=.22){
  if(!audioOn) return; ensureAudio(); if(!AC) return;
  const o=AC.createOscillator(), g=AC.createGain();
  o.type=type; o.frequency.value=f; g.gain.value=v; o.connect(g).connect(master);
  const t=AC.currentTime; g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(v,t+.01); g.gain.exponentialRampToValueAtTime(0.0001,t+d); o.start(t); o.stop(t+d+.02);
}
function fromB64ToAudio(b64){
  if(!audioOn) return null; ensureAudio(); if(!AC) return null;
  const bin = atob(b64); const len = bin.length; const buf = new Uint8Array(len);
  for(let i=0;i<len;i++) buf[i]=bin.charCodeAt(i);
  return AC.decodeAudioData(buf.buffer.slice(0));
}
async function playSample(b64, gain=0.9, rate=1){
  if(!audioOn) return; ensureAudio(); if(!AC) return;
  try{
    const audioBuf = await fromB64ToAudio(b64);
    const src = AC.createBufferSource(); src.buffer = audioBuf; src.playbackRate.value = rate;
    const g = AC.createGain(); g.gain.value = gain; src.connect(g).connect(master); src.start();
  }catch(e){ /* fallback a tono */ }
}
/* Tres samples muy ligeros (sintÃ©ticos en base64) */
const S_WHOOSH = ""; // dejamos tonos/ruido en tiempo real para whoosh
const S_TICK = "";   // usamos tone()
const S_FANFARE = ""; // usamos secuencia de tones + clinks

function whoosh(d=1.7){
  if(!audioOn) return ()=>{}; ensureAudio(); if(!AC) return ()=>{};
  const len=Math.floor(AC.sampleRate*d); const buf=AC.createBuffer(1,len,AC.sampleRate); const ch=buf.getChannelData(0);
  for(let i=0;i<len;i++){ const t=i/len; ch[i]=(Math.random()*2-1)*(1-t) }
  const src=AC.createBufferSource(); src.buffer=buf;
  const bp=AC.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1700; bp.Q.value=0.9;
  const g=AC.createGain(); g.gain.value=.18; src.connect(bp).connect(g).connect(master); src.start();
  return ()=>{ try{src.stop()}catch(e){} };
}
function playTick(i){ tone(260+i*60,.05,'square',.14) }
function playThunk(){ tone(110,.08,'triangle',.26) }
function jingleWin(){ [880,1175,1760].forEach((f,i)=>setTimeout(()=>tone(f,.14,'triangle',.30),i*120)) }
function jingleJack(){ [660,880,1320,1760,1320,880,660].forEach((f,i)=>setTimeout(()=>tone(f,.16,'square',.32),i*140)) }
function coinClinks(){ for(let i=0;i<7;i++) setTimeout(()=>tone(1400+Math.random()*700,.06,'square',.18),80*i) }

/* =========================================================
   Spin avanzado con anticipation, bounce y stops escalonados
========================================================= */
let spinsLeft=MAX_SPINS, spinning=false, inJackpot=false;
const counterEl = document.getElementById('counter'); function updateCounter(){ counterEl.textContent = `Tiradas restantes: ${spinsLeft}` }
updateCounter();

function decideOutcome(){
  const r=Math.random();
  if(r<JACKPOT_PROB) return 'JACKPOT';
  if(r<JACKPOT_PROB+WIN_PROB) return 'WIN';
  return 'NORMAL';
}
function pickId(){ return SYM_IDS[(Math.random()*SYM_IDS.length)|0]; }

function animateColumnTo(colObj, targetY, dur, easeFn, onStop){
  return new Promise(resolve=>{
    const startY = colObj.strip.y || 0;
    const start = performance.now();
    function tick(ts){
      const t = Math.min(1, (ts-start)/dur);
      const e = easeFn(t);
      colObj.strip.y = startY + (targetY - startY) * e;
      if(t<1){ requestAnimationFrame(tick) }
      else { onStop && onStop(); resolve(); }
    }
    requestAnimationFrame(tick);
  });
}
const easeOutCubic = t => 1 - Math.pow(1-t,3);
const easeOutBack = t => { const c1=1.70158, c3=c1+1; return 1 + c3*Math.pow(t-1,3) + c1*Math.pow(t-1,2) };

async function spinTo(targetCenter){
  const stride = SYM_IDS.length * reelRect.cellH;
  const base = 1400;
  const stagger = [0,120,240,360,480];
  const results = [];
  const cleaners = whoosh(1.8);

  for(let i=0;i<COLS;i++){
    const chosen = targetCenter ? targetCenter[i] : pickId();
    const k = SYM_IDS.indexOf(chosen);
    const loops = 6 + i;
    const dest = -(loops*stride + k*reelRect.cellH + PAYLINE*reelRect.cellH);
    await new Promise(r=>setTimeout(r, stagger[i]));
    // anticipation: leve temblor previo
    columns[i].strip.y = columns[i].strip.y || -(Math.random()*stride);
    const pre = columns[i].strip.y - 20;
    await animateColumnTo(columns[i], pre, 120, easeOutCubic);
    // giro principal
    await animateColumnTo(columns[i], dest+12, base+ i*120, easeOutCubic);
    // bounce final
    await animateColumnTo(columns[i], dest, 140, easeOutBack, ()=>{ playTick(i) });
    if(i===COLS-1){ playThunk(); cleaners && cleaners(); }
    results.push(chosen);
  }
  return results;
}

/* =========================================================
   LÃ³gica de juego
========================================================= */
const btn = document.getElementById('spin');
const toggleSound = document.getElementById('sound');
const modalWin = document.getElementById('win');
const modalJack = document.getElementById('jack');

function show(m){ m.classList.add('show') }
function hide(m){ m.classList.remove('show') }
document.querySelectorAll('[data-close]').forEach(b=> b.addEventListener('click', e=>{ const sel=e.currentTarget.getAttribute('data-close'); const m=document.querySelector(sel); if(m) hide(m) }));
function vibrate(p){ if(navigator.vibrate) navigator.vibrate(p) }

async function doSpin(manual=true){
  if(spinning) return;
  if(manual){
    if(spinsLeft<=0) return;
    ensureAudio();
    spinsLeft--; updateCounter();
  }
  spinning = true;
  btn.disabled = true;

  let outcome = 'NORMAL';
  if(manual && !inJackpot) outcome = decideOutcome();

  if(outcome==='JACKPOT' && !inJackpot){
    inJackpot = true; jingleJack(); show(modalJack); vibrate([80,40,120]); setTimeout(()=>hide(modalJack), 900);
    for(let i=1;i<=5;i++){
      let target=null;
      if(i===5){ const id=pickId(); target = Array(COLS).fill(id) }
      else { const id=pickId(); const same=2 + (Math.random()*2|0); target = Array(COLS).fill(null).map((_,k)=> k<same? id : pickId()) }
      await spinTo(target);
      await new Promise(r=>setTimeout(r, 120 + i*70));
    }
    jingleJack(); coinClinks(); show(modalJack); vibrate(220);
    inJackpot=false; spinning=false; btn.disabled = spinsLeft<=0; return;
  }

  let target=null; if(outcome==='WIN'){ const id=pickId(); target=Array(COLS).fill(id) }
  const result = await spinTo(target);
  if(outcome==='WIN'){ jingleWin(); vibrate([60,40,60]); show(modalWin) }

  spinning=false; btn.disabled = spinsLeft<=0;
}

/* UI */
btn.addEventListener('click', ()=>doSpin(true));
toggleSound.addEventListener('click', ()=>{
  audioOn = !audioOn;
  toggleSound.setAttribute('aria-pressed', audioOn?'true':'false');
  toggleSound.innerHTML = audioOn? '<span>ðŸ”Š</span><span>Sonido</span>' : '<span>ðŸ”‡</span><span>Silencio</span>';
  if(audioOn){ ensureAudio(); tone(880,.08,'triangle',.28) }
});
</script>
</body>
</html>
