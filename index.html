<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
<title>Tragamonedas JAC â€” PIXI</title>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<style>
  :root{
    --bg1:#090012; --bg2:#2a0750; --bg3:#0a031b;
    --gold:#ffd76a; --gold2:#ffb200; --cyan:#7df9ff; --magenta:#ff28d0; --violet:#8a3dff; --hot:#ff3b7a;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;height:100%;background:radial-gradient(160% 160% at 50% -20%, var(--bg2), var(--bg1) 40%, var(--bg3));color:#eee;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;overflow:hidden}
  body{display:flex}
  .wrap{position:relative;z-index:2;min-height:100%;width:100%;display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:space-between;padding:10px 12px calc(env(safe-area-inset-bottom,0) + 14px);pointer-events:none}
  header{width:100%;display:flex;align-items:center;justify-content:space-between;gap:10px;pointer-events:auto}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:40px;height:40px;border-radius:14px;background:conic-gradient(from 0deg,var(--gold),#fff6b8,var(--gold2),var(--gold));box-shadow:0 0 18px rgba(255,215,106,.6), inset 0 0 12px rgba(0,0,0,.65);display:grid;place-items:center}
  .logo span{filter:drop-shadow(0 2px 2px rgba(0,0,0,.8));font-size:24px}
  h1{margin:0;font-size:18px;letter-spacing:1px;background:linear-gradient(90deg,#fff,var(--gold));-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 16px rgba(255,215,106,.4)}
  .hud{display:flex;align-items:center;gap:8px}
  .pill{font-weight:800;color:var(--gold);font-size:12px;padding:6px 10px;border-radius:999px;border:1.6px solid rgba(255,215,106,.8);background:rgba(255,215,106,.10);box-shadow:inset 0 0 12px rgba(255,215,106,.18)}
  .toggle{appearance:none;border:1.6px solid rgba(255,215,106,.8);background:rgba(0,0,0,.35);color:#fff;border-radius:999px;padding:6px 10px;font-size:12px;display:flex;align-items:center;gap:6px;cursor:pointer}
  .controls{display:flex;align-items:center;justify-content:center;margin-top:2px;pointer-events:auto}
  .btn{--size:110px;width:var(--size);height:var(--size);border-radius:999px;border:none;cursor:pointer;position:relative;display:grid;place-items:center;
    background:radial-gradient(120% 120% at 50% 0%, #460a8e, #2a0a52 45%, #180634);
    box-shadow:0 26px 40px rgba(0,0,0,.82), inset 0 0 30px rgba(255,215,106,.26), 0 0 30px rgba(250,80,255,.45);
    border:2px solid rgba(255,215,106,.95); color:#fff; font-weight:900; letter-spacing:1px; text-transform:uppercase; font-size:18px}
  .btn span{position:relative;z-index:2;text-shadow:0 2px 0 rgba(0,0,0,.6),0 0 14px rgba(255,215,106,.55)}
  .btn::before{content:"";position:absolute;inset:-8px;border-radius:inherit;background:conic-gradient(from 0deg, rgba(255,215,106,.0), rgba(255,215,106,.85), rgba(255,215,106,.0));filter:blur(10px);animation:spinRing 2.2s linear infinite;opacity:.95}
  .btn:active{transform:translateY(1px) scale(.985)}
  .btn[disabled]{opacity:.55;filter:grayscale(.25);cursor:not-allowed}
  @keyframes spinRing{to{transform:rotate(1turn)}}

  canvas{position:fixed;inset:0;width:100%;height:100%;z-index:1}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(5,3,12,.82);backdrop-filter:blur(5px);z-index:5}
  .modal.show{display:flex}
  .card{min-width:74%;max-width:520px;padding:24px 18px 18px;border-radius:24px;border:2px solid rgba(255,215,106,.98);background:radial-gradient(120% 140% at 50% 0%, rgba(255,255,255,.12), rgba(255,255,255,.05));box-shadow:0 24px 56px rgba(0,0,0,.9), inset 0 0 140px rgba(255,215,106,.18);text-align:center;position:relative;overflow:hidden}
  .card h2{margin:0 0 8px;background:linear-gradient(90deg,var(--gold),#fff,var(--gold));-webkit-background-clip:text;background-clip:text;color:transparent;font-size:30px;letter-spacing:1.6px}
  .card p{margin:0 0 16px;opacity:.96}
  .ok{margin-top:6px;padding:10px 20px;border-radius:999px;border:1.6px solid rgba(255,215,106,.95);background:rgba(0,0,0,.68);color:#fff;font-size:14px;cursor:pointer}

  .orient{position:fixed;inset:0;background:#070312;color:#eee;display:none;align-items:center;justify-content:center;z-index:6;text-align:center;padding:24px}
  .orient.show{display:flex}
</style>
</head>
<body>
<canvas id="stage" aria-label="MÃ¡quina tragamonedas"></canvas>

<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo"><span>ðŸš—</span></div>
      <h1>Tragamonedas JAC</h1>
    </div>
    <div class="hud">
      <div id="counter" class="pill" aria-live="polite">Tiradas restantes: 10</div>
      <button id="sound" class="toggle" aria-pressed="true"><span>ðŸ”Š</span><span>Sonido</span></button>
    </div>
  </header>

  <div class="controls">
    <button id="spin" class="btn"><span>Girar</span></button>
  </div>
</div>

<!-- PREMIO -->
<div class="modal" id="win">
  <div class="card">
    <h2>Â¡PREMIO!</h2>
    <p>5 sÃ­mbolos iguales en la lÃ­nea central.</p>
    <button class="ok" data-close="#win">Aceptar</button>
  </div>
</div>

<!-- PREMIO MAYOR -->
<div class="modal" id="jack">
  <div class="card">
    <h2>ðŸŽ‰ Â¡PREMIO MAYOR! ðŸŽ‰</h2>
    <p>Se activa el modo especial con 5 tiradas automÃ¡ticas culminando en 5 iguales.</p>
    <button class="ok" data-close="#jack">Continuar</button>
  </div>
</div>

<div class="orient" id="orient">
  <div>
    <h3>Gira tu telÃ©fono</h3>
    <p>Este juego estÃ¡ optimizado para orientaciÃ³n vertical.</p>
  </div>
</div>

<!-- PIXI.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.3/pixi.min.js" integrity="" crossorigin="anonymous"></script>
<script>
/* =========================================================
   ConfiguraciÃ³n general
========================================================= */
const ROWS=3, COLS=5, MAX_SPINS=10, PAYLINE=1;
const JACKPOT_PROB=0.05, WIN_PROB=0.10;
const app = new PIXI.Application({ view: document.getElementById('stage'), resizeTo: window, antialias: true, backgroundAlpha: 0 });
const stage = app.stage;

/* =========================================================
   Layout
========================================================= */
let W=innerWidth, H=innerHeight;
function layout(){
  W=innerWidth; H=innerHeight;
  const isLand = matchMedia('(orientation: landscape)').matches;
  document.getElementById('orient').classList.toggle('show', isLand);
}
addEventListener('resize', layout); addEventListener('orientationchange', layout); layout();

/* =========================================================
   SÃ­mbolos (texturas generadas)
========================================================= */
const SYMBOL_IDS = ['sedan','suv','pickup','volante','veloc','llaves','bateria','estrella','bono','test'];
const textures = {};
function drawSymbol(id){
  const g = new PIXI.Graphics();
  const w=220, h=180;
  // tarjeta base
  const grad = new PIXI.Graphics();
  grad.beginFill(0xffffff, 0.08).drawRoundedRect(0,0,w,h,22).endFill();
  const border = new PIXI.Graphics();
  border.lineStyle(4, 0xffd76a, 1).drawRoundedRect(0,0,w,h,22);
  const bevel = new PIXI.Graphics();
  bevel.beginFill(0xffd76a, 0.18).drawRoundedRect(6,6,w-12, h-12, 18).endFill();
  const inner = new PIXI.Container(); inner.addChild(grad, bevel, border);

  // Ã­cono
  const icon = new PIXI.Graphics();
  icon.x = w/2; icon.y = h/2;
  icon.lineStyle(0);
  const gold = 0xffd76a;
  switch(id){
    case 'sedan':
      icon.lineStyle(5, gold, 1);
      icon.drawPolygon([-70,20,  70,20,  50,-20,  0,-45, -40,-45, -65,-20]);
      icon.beginFill(gold).drawCircle(-40,28,12).drawCircle(40,28,12).endFill();
      break;
    case 'suv':
      icon.lineStyle(5, gold, 1);
      icon.drawPolygon([-72,22,  72,22,  58,-18,  5,-45, -40,-45, -62,-18]);
      icon.beginFill(gold).drawCircle(-42,30,11).drawCircle(42,30,11).endFill();
      break;
    case 'pickup':
      icon.lineStyle(5, gold, 1);
      icon.drawPolygon([-75,20, 75,20, 75,-18, 25,-18, 0,-45, -35,-45, -55,-18, -75,-18]);
      icon.beginFill(gold).drawCircle(-42,30,11).drawCircle(42,30,11).endFill();
      break;
    case 'volante':
      icon.lineStyle(5, gold, 1);
      icon.drawCircle(0,0,50); icon.beginFill(gold).drawCircle(0,0,20).endFill();
      icon.lineStyle(4, gold,1).moveTo(-35,0).lineTo(35,0).moveTo(-15,-20).lineTo(-55,-30).moveTo(15,-20).lineTo(55,-30);
      break;
    case 'veloc':
      icon.lineStyle(5, gold, 1);
      icon.drawCircle(0,10,44);
      icon.lineStyle(6, gold, 1).moveTo(0,10).lineTo(26,-16);
      break;
    case 'llaves':
      icon.lineStyle(5, gold, 1); icon.drawCircle(-20,-10,22);
      icon.lineStyle(5, gold, 1).moveTo(0,10).lineTo(60,60).moveTo(60,60).lineTo(74,46).moveTo(74,46).lineTo(86,58);
      break;
    case 'bateria':
      icon.lineStyle(5, gold, 1).drawRoundedRect(-55,-30,110,60,10);
      icon.beginFill(gold).drawRect(56,-16,8,32).endFill();
      icon.lineStyle(5, gold, 1).moveTo(0,-26).lineTo(-18,14).moveTo(-18,14).lineTo(6,14).moveTo(6,14).lineTo(-10,44);
      break;
    case 'estrella':
      icon.beginFill(gold,1);
      icon.drawStar(0,0,5,36,18); icon.endFill();
      icon.lineStyle(3, gold, .9).drawStar(0,0,5,36,18);
      break;
    case 'bono':
      icon.lineStyle(5, gold, 1).drawRoundedRect(-60,-28,120,56,12);
      break;
    case 'test':
      icon.lineStyle(5, gold, 1).drawRoundedRect(-60,-40,120,80,12);
      icon.lineStyle(5, gold, 1).moveTo(-40,-5).lineTo(40,-5).moveTo(-40,18).lineTo(10,18);
      icon.beginFill(gold).drawCircle(42,18,10).endFill();
      break;
  }
  const cont = new PIXI.Container(); cont.addChild(inner); icon.x+=0; icon.y+=5; cont.addChild(icon);
  const tex = app.renderer.generateTexture(cont, {resolution: window.devicePixelRatio||1});
  return tex;
}

for(const id of SYMBOL_IDS){ textures[id]=drawSymbol(id); }

/* =========================================================
   Reels
========================================================= */
const viewport = new PIXI.Container();
stage.addChild(viewport);

let reelArea = { x:0, y:0, w:0, h:0, cellH:0 };
function sizeReels(){
  const w = Math.min(560, W*0.92);
  const h = Math.min(520, H*0.62);
  reelArea = { x:(W-w)/2, y:(H-h)/2-20, w:w, h:h, cellH: (h-20)/3 };
}
sizeReels();

const reels = []; // {container,strips:[sprites], y}
function buildStrips(){
  viewport.removeChildren();
  reels.length = 0;
  for(let c=0;c<COLS;c++){
    const col = new PIXI.Container();
    col.x = reelArea.x + c*(reelArea.w/cols) + (c*10) - 0;
    col.y = reelArea.y + 10;
    viewport.addChild(col);

    // vertical strip: repeat many rows to simulate inertia
    const strip = new PIXI.Container();
    col.addChild(strip);
    const perRow = SYMBOL_IDS.length;
    const repeats = 10;
    let y=0;
    for(let r=0;r<repeats;r++){
      for(const id of SYMBOL_IDS){
        const sp = new PIXI.Sprite(textures[id]);
        sp.anchor.set(0.5);
        sp.x = (reelArea.w/COLS)/2;
        sp.y = y + reelArea.cellH/2;
        sp.scale.set(Math.min((reelArea.cellH-10)/180, (reelArea.w/COLS-10)/220));
        strip.addChild(sp);
        y += reelArea.cellH;
      }
    }
    reels.push({col, strip, y:0});
  }
}
const cols = COLS;
buildStrips();

/* Payline marker (glow line) */
const payline = new PIXI.Graphics();
function drawPayline(){
  payline.clear();
  payline.lineStyle(3, 0x7df9ff, 0.8);
  payline.moveTo(reelArea.x+10, reelArea.y + reelArea.cellH*PAYLINE + 10);
  payline.lineTo(reelArea.x+reelArea.w-10, reelArea.y + reelArea.cellH*PAYLINE + 10);
  stage.addChild(payline);
}
drawPayline();

/* Mask to clip reels */
const mask = new PIXI.Graphics();
function drawMask(){
  mask.clear();
  mask.beginFill(0xffffff,1).drawRoundedRect(reelArea.x, reelArea.y, reelArea.w, reelArea.h, 24).endFill();
  viewport.mask = mask; stage.addChild(mask);
}
drawMask();

/* =========================================================
   Spin system
========================================================= */
let spinsLeft = MAX_SPINS;
let spinning = false;
let inJackpot = false;

function updateCounter(){ document.getElementById('counter').textContent = `Tiradas restantes: ${spinsLeft}`; }
updateCounter();

function decide(){
  const r = Math.random();
  if(r < JACKPOT_PROB) return 'JACKPOT';
  if(r < JACKPOT_PROB + WIN_PROB) return 'WIN';
  return 'NORMAL';
}
function pickId(){ return SYMBOL_IDS[(Math.random()*SYMBOL_IDS.length)|0]; }

function spinTo(targetCenter){ // targetCenter: array of 5 ids or null
  return new Promise(res=>{
    const base=1400, delays=[0,120,240,360,480];
    const start = performance.now();
    const stride = SYMBOL_IDS.length * reelArea.cellH;
    reels.forEach((R,idx)=>{
      const ini = - (Math.random()*stride);
      R.strip.y = ini;
      const loops = 6 + idx;
      const chosen = targetCenter ? targetCenter[idx] : pickId();
      const k = SYMBOL_IDS.indexOf(chosen);
      const dest = -(loops*stride + k*reelArea.cellH + PAYLINE*reelArea.cellH);
      const dur = base + delays[idx];
      const ease = t => 1 - Math.pow(1-t,3);

      function frame(ts){
        const t = Math.min(1, (ts-start)/dur);
        const y = ini + (dest-ini)*ease(t);
        R.strip.y = y;
        if(t<1){ requestAnimationFrame(frame) }
        else{
          playTick(idx);
          if(idx===reels.length-1){ playThunk(); res(); }
        }
      }
      requestAnimationFrame(frame);
    });
  });
}

/* =========================================================
   Audio (WebAudio)
========================================================= */
let audioOn = true, AC = null, master = null;
function ensureAudio(){
  if(AC) return;
  const C = window.AudioContext || window.webkitAudioContext;
  if(!C) return;
  AC = new C();
  master = AC.createGain();
  master.gain.value = 0.9;
  master.connect(AC.destination);
}
function tone(f=440,d=.1,type='sine',v=.2){
  if(!audioOn) return;
  ensureAudio(); if(!AC) return;
  const o=AC.createOscillator(), g=AC.createGain();
  o.type=type; o.frequency.value=f; g.gain.value=v;
  o.connect(g).connect(master);
  const t=AC.currentTime;
  g.gain.setValueAtTime(0,t);
  g.gain.linearRampToValueAtTime(v,t+.01);
  g.gain.exponentialRampToValueAtTime(0.0001,t+d);
  o.start(t); o.stop(t+d+.02);
}
function whoosh(d=1.7){
  if(!audioOn) return ()=>{};
  ensureAudio(); if(!AC) return ()=>{};
  const len=Math.floor(AC.sampleRate*d);
  const buf=AC.createBuffer(1,len,AC.sampleRate);
  const ch=buf.getChannelData(0);
  for(let i=0;i<len;i++){ const t=i/len; ch[i]=(Math.random()*2-1)*(1-t) }
  const src=AC.createBufferSource(); src.buffer=buf;
  const bp=AC.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1700; bp.Q.value=0.9;
  const g=AC.createGain(); g.gain.value=.18;
  src.connect(bp).connect(g).connect(master);
  src.start();
  return ()=>{ try{src.stop()}catch(e){} };
}
function playTick(i){ tone(260+i*60,.05,'square',.14) }
function playThunk(){ tone(110,.08,'triangle',.24) }
function jingleWin(){ [880,1175,1760].forEach((f,i)=>setTimeout(()=>tone(f,.14,'triangle',.28),i*120)) }
function jingleJack(){ [660,880,1320,1760,1320,880,660].forEach((f,i)=>setTimeout(()=>tone(f,.16,'square',.30),i*140)) }
function coinClinks(){ for(let i=0;i<6;i++) setTimeout(()=>tone(1400+Math.random()*700,.06,'square',.16),80*i) }

/* =========================================================
   UX: modals, vibraciÃ³n, overlays
========================================================= */
const btn = document.getElementById('spin');
const toggleSound = document.getElementById('sound');
const modalWin = document.getElementById('win');
const modalJack = document.getElementById('jack');

function show(m){ m.classList.add('show') }
function hide(m){ m.classList.remove('show') }
document.querySelectorAll('[data-close]').forEach(b=> b.addEventListener('click', e=>{
  const sel=e.currentTarget.getAttribute('data-close'); const m=document.querySelector(sel); if(m) hide(m);
}));

function vibrate(p){ if(navigator.vibrate) navigator.vibrate(p) }

/* =========================================================
   LÃ³gica de juego
========================================================= */
async function doSpin(manual=true){
  if(spinning) return;
  if(manual){
    if(spinsLeft<=0) return;
    ensureAudio();
    spinsLeft--; updateCounter();
  }
  spinning = true;
  btn.disabled = true;
  const stopWhoosh = whoosh(1.8);

  let outcome = 'NORMAL';
  if(manual && !inJackpot){
    const d = decide();
    outcome = d;
  }

  if(outcome==='JACKPOT' && !inJackpot){
    inJackpot = true;
    jingleJack(); show(modalJack); vibrate([80,40,120]);
    setTimeout(()=>hide(modalJack), 900);

    // 5 auto tiradas
    for(let i=1;i<=5;i++){
      let target=null;
      if(i===5){
        const sym = pickId();
        target = Array(COLS).fill(sym);
      }else{
        const sym = pickId();
        const same = 2 + Math.floor(Math.random()*2);
        target = Array(COLS).fill(null).map((_,k)=> k<same? sym : pickId());
      }
      await spinTo(target);
      await new Promise(r=>setTimeout(r, 120 + i*70));
    }
    jingleJack(); coinClinks(); show(modalJack); vibrate(220);
    inJackpot=false; spinning=false; btn.disabled = spinsLeft<=0; if(stopWhoosh) stopWhoosh(); return;
  }

  let target=null;
  if(outcome==='WIN'){
    const sym = pickId();
    target = Array(COLS).fill(sym);
  }
  await spinTo(target);
  if(stopWhoosh) stopWhoosh();

  if(outcome==='WIN'){ jingleWin(); vibrate([60,40,60]); show(modalWin); }

  spinning=false; btn.disabled = spinsLeft<=0;
}

/* =========================================================
   Eventos UI
========================================================= */
btn.addEventListener('click', ()=>doSpin(true));
toggleSound.addEventListener('click', ()=>{
  audioOn = !audioOn;
  toggleSound.setAttribute('aria-pressed', audioOn?'true':'false');
  toggleSound.innerHTML = audioOn? '<span>ðŸ”Š</span><span>Sonido</span>' : '<span>ðŸ”‡</span><span>Silencio</span>';
  if(audioOn){ ensureAudio(); tone(880,.08,'triangle',.26); }
});

</script>
</body>
</html>
