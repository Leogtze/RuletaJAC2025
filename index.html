<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>SLOT JAC</title>
<style>
  :root{
    --bg1:#0c0620; --bg2:#080313;
    --panel:#0e1321;
    --gold:#ffd766; --gold2:#d4af37; --amber:#ffec99;
    --led-on:#ffd766; --led-off:#3b2b07;
    --accent:#7b2cff; --teal:#00e6a3; --pink:#ff6fb3; --blue:#8fd0ff; --lime:#c7ff7a;
    --text:#f5f8ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text); font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    background:
      radial-gradient(1200px 700px at 50% -10%, rgba(255,215,102,.20), transparent 55%),
      radial-gradient(1400px 900px at 100% 0%, rgba(123,44,255,.18), transparent 60%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
    min-height:100svh; display:flex; align-items:center; justify-content:center; padding:10px;
  }

  /* ---------- Cabinet principal ---------- */
  .cab{
    width:min(540px, 96vw);
    border-radius:26px;
    background:
      radial-gradient(900px 360px at 50% -35%, rgba(255,215,102,.22), transparent 60%),
      linear-gradient(180deg,#0f1424,#0a0f18);
    box-shadow:
      0 30px 90px rgba(0,0,0,.58),
      inset 0 0 0 2px rgba(255,255,255,.06),
      inset 0 0 160px rgba(0,0,0,.72);
    position:relative; overflow:hidden; padding:12px;
  }

  /* Marco LED animado */
  .cab::before{
    content:""; position:absolute; inset:6px; border-radius:20px; pointer-events:none;
    background:
      radial-gradient(6px 6px at 12px 12px, var(--led-on) 45%, transparent 46%) 0 0/24px 24px,
      radial-gradient(6px 6px at 12px 12px, var(--led-on) 45%, transparent 46%) 12px 12px/24px 24px,
      radial-gradient(6px 6px at 12px 12px, var(--led-on) 45%, transparent 46%) 0 12px/24px 24px,
      radial-gradient(6px 6px at 12px 12px, var(--led-on) 45%, transparent 46%) 12px 0/24px 24px;
    filter: drop-shadow(0 0 6px rgba(255,215,102,.9));
    mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
    -webkit-mask-composite: xor; mask-composite: exclude;
    animation: leds 1.8s linear infinite;
    padding:10px; border:2px solid rgba(255,255,255,.06);
  }
  @keyframes leds{ to { transform: translateX(24px) } }

  /* Header */
  .top{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .brand{
    font-weight:1000; letter-spacing:.8px; font-size: clamp(18px, 5.2vw, 28px);
    color:var(--gold);
    text-shadow: 0 0 20px rgba(255,215,102,.75), 0 0 2px #000;
  }
  .meta{ display:flex; gap:8px; align-items:center }
  .badge{
    font-weight:900; padding:6px 10px; border-radius:12px;
    background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.12);
  }

  /* Controles audio */
  .audio{
    position:absolute; top:10px; right:12px; display:flex; gap:8px; align-items:center; z-index:20;
    background:rgba(0,0,0,.35); padding:6px 8px; border-radius:12px; border:1px solid rgba(255,255,255,.15);
  }
  .muteb{ cursor:pointer; border:none; border-radius:10px; padding:6px 10px; font-weight:900;
    background:linear-gradient(180deg, var(--gold), #d2a837); color:#2a1c00; box-shadow:0 6px 0 #8f7013}
  .muteb:active{ transform:translateY(2px); box-shadow:0 4px 0 #8f7013}
  .vol{ width:92px }

  /* Pantalla de reels */
  .screen{
    margin-top:8px; border-radius:16px; overflow:hidden; position:relative;
    border:1px solid rgba(255,255,255,.12);
    background:
      radial-gradient(900px 340px at 50% -30%, rgba(255,215,102,.16), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    box-shadow: inset 0 0 60px rgba(0,0,0,.58);
  }
  /* Cristal */
  .screen::after{
    content:""; position:absolute; inset:0; pointer-events:none;
    background: linear-gradient(60deg, rgba(255,255,255,.18), transparent 40% 60%, rgba(255,255,255,.12));
    mix-blend-mode: screen; opacity:.45;
  }

  .grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; padding:10px 8px 14px; position:relative; }
  .reel{
    height:300px; border-radius:12px; overflow:hidden; position:relative;
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.30));
    box-shadow: inset 0 0 32px rgba(0,0,0,.65);
  }
  .reel::before{
    content:""; position:absolute; inset:0; background:
      linear-gradient(90deg, rgba(255,255,255,.06), transparent 35% 65%, rgba(255,255,255,.06));
    mix-blend-mode: screen; pointer-events:none;
  }

  .strip{ position:absolute; width:100%; top:0; left:0; will-change:transform; }
  .symbol{
    height:100px; display:grid; place-items:center;
    font-size:54px; font-weight:1000; color:#fff;
    text-shadow:0 3px 12px rgba(0,0,0,.65);
    border-bottom:1px solid rgba(255,255,255,.06);
    background:
      radial-gradient(220px 90px at 50% 12%, rgba(255,255,255,.18), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.015));
  }
  /* Colores base de s√≠mbolos */
  .s-7{ color:var(--gold); text-shadow:0 0 22px rgba(255,215,102,.9), 0 0 3px #000; font-size:58px }
  .s-cherry{ color:#ff6b6b }
  .s-lemon{ color:#ffe06b }
  .s-plum{ color:#c88bff }
  .s-kiwi{ color:#97ff9e }
  .s-star{ color:#fff0a6 }

  /* L√≠nea de pago */
  .payline{
    position:absolute; left:4%; right:4%; top:50%;
    border-top:3px solid rgba(255,215,102,.8);
    filter: drop-shadow(0 0 6px rgba(255,215,102,1));
    transform: translateY(-50%);
  }
  .payline.flash{ animation: payflash .8s ease-out 2 }
  @keyframes payflash{ 50%{ filter: drop-shadow(0 0 12px #fff); border-top-color:#fff } }

  /* Palanca + bot√≥n */
  .controls{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; margin-top:12px; }
  .lever{
    width:118px; height:140px; border-radius:14px; position:relative; overflow:hidden;
    background:linear-gradient(180deg,#0b1018,#0a0e15);
    border:1px solid rgba(255,255,255,.08);
    box-shadow: inset 0 0 28px rgba(0,0,0,.65);
  }
  .stick{
    position:absolute; bottom:14px; left:50%; transform:translateX(-50%); width:9px; height:100px;
    background:linear-gradient(180deg, #777, #222); border-radius:6px;
    transform-origin: bottom center; transition: transform .16s ease;
  }
  .knob{
    position:absolute; left:50%; bottom:108px; transform:translateX(-50%);
    width:44px; height:44px; border-radius:999px;
    background: radial-gradient(circle at 30% 30%, #ff718a, #c4002b 70%);
    box-shadow: 0 0 16px rgba(255,80,120,.6), inset 0 0 8px rgba(255,255,255,.35);
    border:2px solid rgba(255,255,255,.25);
  }
  .lever.pull .stick{ transform:translateX(-50%) rotate(-22deg) }

  .btn{
    padding:16px 18px; border:none; cursor:pointer; user-select:none; border-radius:14px;
    color:#231700; font-weight:1000; text-transform:uppercase; letter-spacing:.7px;
    background:
      radial-gradient(160px 60px at 50% 0%, rgba(255,255,255,.6), transparent 50%),
      linear-gradient(180deg, var(--gold), #d2a837);
    box-shadow: 0 12px 0 #8f7013, 0 18px 30px rgba(0,0,0,.45);
    transition: transform .06s ease, box-shadow .06s ease, filter .06s ease;
  }
  .btn:active:not(:disabled){ transform:translateY(4px); box-shadow:0 8px 0 #8f7013, 0 12px 20px rgba(0,0,0,.5)}
  .btn:disabled{ filter:saturate(.25) brightness(.85); cursor:not-allowed; box-shadow:0 12px 0 #675511, 0 14px 22px rgba(0,0,0,.35) }
  .status{ text-align:center; margin-top:8px; min-height:1.4em; font-weight:800; opacity:.95 }

  /* Overlays de victoria y fin de juego */
  .overlay{ position:fixed; inset:0; display:none; place-items:center; z-index:9999;
    background: radial-gradient(1000px 520px at 50% 20%, rgba(0,0,0,.62), rgba(0,0,0,.9)); backdrop-filter: blur(2px);}
  .overlay.show{ display:grid }
  .card{
    width:min(560px, 92vw); border-radius:22px; text-align:center; padding:24px 18px;
    background:
      radial-gradient(520px 220px at 50% -10%, rgba(255,215,102,.3), transparent 60%),
      linear-gradient(180deg,#0f1522,#0a0f18);
    border:1px solid rgba(255,255,255,.14);
    box-shadow: 0 30px 140px rgba(0,0,0,.65), inset 0 0 140px rgba(255,215,102,.14);
  }
  .t1{ font-size: clamp(24px, 6.5vw, 40px); font-weight:1000; color:var(--gold);
       text-shadow:0 0 22px rgba(255,215,102,.75) }
  .jackpot-777{ font-size: clamp(40px, 16vw, 92px); letter-spacing:4px; margin:6px 0 6px;
    color:var(--gold); text-shadow:0 0 30px rgba(255,215,102,1), 0 0 4px #000; font-weight:1000 }
  .t2{ opacity:.98; margin:10px 0 4px }
  .winbtn{ margin-top:12px }

  /* Part√≠culas */
  #coins,#confetti{ position:fixed; inset:0; pointer-events:none; z-index:9998 }

  /* Accesibilidad */
  @media (prefers-reduced-motion:reduce){
    .cab::before{ animation:none }
  }
</style>
</head>
<body>
  <canvas id="coins"></canvas>
  <canvas id="confetti"></canvas>

  <div class="cab">
    <div class="audio">
      <button id="mute" class="muteb">üîä</button>
      <input id="vol" class="vol" type="range" min="0" max="1" step="0.01" value="0.7" />
    </div>

    <div class="top">
      <div class="brand">SLOT JAC</div>
      <div class="meta">
        <div class="badge">Tiradas: <span id="left">10</span></div>
      </div>
    </div>

    <div class="screen">
      <div class="grid" id="reels">
        <div class="reel"><div class="strip"></div></div>
        <div class="reel"><div class="strip"></div></div>
        <div class="reel"><div class="strip"></div></div>
        <div class="payline" id="payline"></div>
      </div>
    </div>

    <div class="controls">
      <div class="lever" id="lever">
        <div class="stick"></div>
        <div class="knob"></div>
      </div>
      <button id="spin" class="btn">Tirar</button>
    </div>
    <div id="status" class="status"></div>
  </div>

  <!-- Overlay de resultado -->
  <div id="overlay" class="overlay">
    <div class="card" id="winCard">
      <div class="t1" id="winTitle">¬°PREMIO!</div>
      <div class="jackpot-777" id="jackpot777" style="display:none;">777</div>
      <div class="t2" id="winSub">Comun√≠cate con el asesor JAC para canjearlo.</div>
      <button class="btn winbtn" id="closeWin">Seguir jugando</button>
    </div>
  </div>

  <!-- Overlay fin de juego -->
  <div id="overlayEnd" class="overlay">
    <div class="card">
      <div class="t1">¬°Termin√≥ el juego!</div>
      <div class="t2">Gracias por participar.</div>
      <button class="btn winbtn" id="reset">Cerrar</button>
    </div>
  </div>

<script>
/* ================= CONFIG ================= */
const CONFIG = {
  totalSpins: 10,
  jackpotChance: 0.05,       // 5% tres 7
  premioChance: 0.10,        // 10% premio normal
  symbolsPerReel: 27,
  spinTimeMs: 1900,          // total ~2.3s con escalonado
  reelStaggerMs: 180,
  easing: (t)=>1 - Math.pow(1 - t, 3), // easeOutCubic
  texts: {
    premioTitle: "¬°PREMIO!",
    premioDesc: "Comun√≠cate con el asesor JAC para canjearlo.",
    jackpotTitle: "PREMIO MAYOR",
    jackpotDesc: "¬°Felicidades! Comun√≠cate con el asesor JAC para canjearlo.",
  }
};

/* ================ S√≠mbolos premium (estilo casino) ================ */
/* SVG de alto detalle: 7 dorado, cereza, lim√≥n, ciruela, kiwi, estrella */
const SYMBOLS = [
  { id:"7", className:"s-7", render:sevenSVG },
  { id:"cherry", className:"s-cherry", render:cherrySVG },
  { id:"lemon", className:"s-lemon", render:lemonSVG },
  { id:"plum", className:"s-plum", render:plumSVG },
  { id:"kiwi", className:"s-kiwi", render:kiwiSVG },
  { id:"star", className:"s-star", render:starSVG },
];
const byId = id => SYMBOLS.find(s=>s.id===id);

/* ================ Estado / DOM ================ */
const keySpins = "slot_jac_spins_v3";
let used = Number(localStorage.getItem(keySpins) || 0);
let spinning = false;

const reelsEl = document.getElementById('reels');
const spinBtn = document.getElementById('spin');
const statusEl = document.getElementById('status');
const leftEl = document.getElementById('left');
const lever = document.getElementById('lever');
const paylineEl = document.getElementById('payline');

const overlay = document.getElementById('overlay');
const closeWin = document.getElementById('closeWin');
const winTitle = document.getElementById('winTitle');
const winSub = document.getElementById('winSub');
const jackpot777 = document.getElementById('jackpot777');

const overlayEnd = document.getElementById('overlayEnd');
const resetBtn = document.getElementById('reset');

const muteBtn = document.getElementById('mute');
const volCtl = document.getElementById('vol');

/* ================ Inicializaci√≥n ================ */
updateLeft();
buildInitial();
setupAudioUI();

spinBtn.addEventListener('click', onSpin);
closeWin.addEventListener('click', ()=> overlay.classList.remove('show'));
resetBtn.addEventListener('click', ()=> overlayEnd.classList.remove('show'));

/* ================ L√≥gica principal ================ */
function onSpin(){
  if (spinning) return;
  if (used >= CONFIG.totalSpins){
    status("Has usado tus 10 tiradas.");
    overlayEnd.classList.add('show');
    return;
  }

  spinning = true;
  spinBtn.disabled = true;
  lever.classList.add('pull');
  paylineEl.classList.remove('flash');
  status("");

  audio.click();             // tap
  audio.lever();             // palanca
  audio.spinLoop(true);      // arranca loop de giro

  const outcome = drawOutcome();
  const line = chooseLine(outcome);

  const rs = [...reelsEl.querySelectorAll('.reel')];
  const promises = rs.map((reel,i)=> spinTo(reel, line[i], CONFIG.spinTimeMs + i*CONFIG.reelStaggerMs, i));

  Promise.all(promises).then(()=>{
    lever.classList.remove('pull');
    used++; localStorage.setItem(keySpins, String(used));
    updateLeft();

    audio.spinLoop(false);   // apaga loop
    paylineEl.classList.add('flash');

    if (outcome.type==='jackpot'){
      showWin(true, CONFIG.texts.jackpotTitle, CONFIG.texts.jackpotDesc);
      audio.winJackpot();
    } else if (outcome.type==='premio'){
      showWin(false, CONFIG.texts.premioTitle, CONFIG.texts.premioDesc);
      audio.winPremio();
    } else {
      status("¬°Sigue intentando!");
      // si se acabaron aqu√≠, mostrar fin
      if (used>=CONFIG.totalSpins){ setTimeout(()=>overlayEnd.classList.add('show'), 400); }
    }

    spinBtn.disabled = (used>=CONFIG.totalSpins);
    spinning = false;
  }).catch(()=>{
    lever.classList.remove('pull');
    spinning = false; spinBtn.disabled = false;
    audio.spinLoop(false);
  });
}

function updateLeft(){
  const left = Math.max(0, CONFIG.totalSpins - used);
  leftEl.textContent = left;
  if (left<=0) spinBtn.disabled = true;
}

function drawOutcome(){
  const r = Math.random();
  if (r < CONFIG.jackpotChance) return {type:'jackpot'};
  if (r < CONFIG.jackpotChance + CONFIG.premioChance) return {type:'premio'};
  return {type:'none'};
}

function chooseLine(outcome){
  if (outcome.type==='jackpot') return ['7','7','7'];
  if (outcome.type==='premio'){
    // Elegir aleatoriamente un s√≠mbolo (no 7) para triple
    const pool = SYMBOLS.map(s=>s.id).filter(id=>id!=='7');
    const id = pool[Math.floor(Math.random()*pool.length)];
    return [id,id,id];
  }
  // no win ‚Äì evitar triple y 2/3 de 7
  const pool = SYMBOLS.map(s=>s.id);
  let a = rand(pool), b = rand(pool), c = rand(pool);
  if (a===b && b===c) c = rand(pool.filter(x=>x!==a));
  const cnt7 = [a,b,c].filter(x=>x==='7').length;
  if (cnt7>=2){ if (a==='7') a = rand(pool.filter(x=>x!=='7'));
                if (b==='7') b = rand(pool.filter(x=>x!=='7'));
                if (c==='7') c = rand(pool.filter(x=>x!=='7')); }
  return [a,b,c];
}

/* F√≠sica de giro: easing + ‚Äúthunk‚Äù en parada */
function spinTo(reelEl, targetId, duration, idx){
  const strip = reelEl.querySelector('.strip');
  const n = CONFIG.symbolsPerReel;

  const arr = [];
  while(arr.length<n) arr.push(SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)]);

  const target = byId(targetId);
  arr[n-3] = target; // aterriza centro
  arr[n-2] = rand(SYMBOLS.filter(s=>s.id!==targetId));
  arr[n-1] = rand(SYMBOLS.filter(s=>s.id!==targetId));

  strip.innerHTML = arr.map(s=>`<div class="symbol ${s.className}">${s.render()}</div>`).join('');

  const h = 100, finalIndex = n-3, finalY = -((finalIndex - 1) * h);
  strip.style.transform = `translateY(0px)`;

  return animate(duration, t=>{
    const y = lerp(0, finalY, CONFIG.easing(t));
    strip.style.transform = `translateY(${y}px)`;
    if (t>0.92 && !strip._thunk){ strip._thunk=true; audio.stopThunk(idx); } // golpe suave al frenar
  }).then(()=>{ strip._thunk=false; });
}

/* ================ Ganar (overlay + FX) ================ */
function showWin(isJackpot, title, desc){
  winTitle.textContent = title;
  winSub.textContent = desc;
  jackpot777.style.display = isJackpot ? 'block' : 'none';
  overlay.classList.add('show');
  burstCoins(isJackpot ? 340 : 160);
  confetti(isJackpot ? 230 : 120);
}

/* ================ Utilidades ================ */
function status(msg){ statusEl.textContent = msg || ""; }
function rand(a){ return a[Math.floor(Math.random()*a.length)] }
function lerp(a,b,t){ return a + (b-a)*t; }
function animate(d, cb){ return new Promise(res=>{ const st=performance.now(); const f=(n)=>{ const t=Math.min(1,(n-st)/d); cb(t); if(t<1) requestAnimationFrame(f); else res(); }; requestAnimationFrame(f); }); }

/* ================ Part√≠culas: Monedas ================ */
const coinCanvas = document.getElementById('coins');
const coinCtx = coinCanvas.getContext('2d');
let coins = [], coinRAF=null;
function resizeCoins(){ coinCanvas.width = innerWidth; coinCanvas.height = innerHeight; }
addEventListener('resize', resizeCoins); resizeCoins();

function burstCoins(count=160){
  const w=coinCanvas.width, h=coinCanvas.height;
  const reduce = matchMedia('(prefers-reduced-motion: reduce)').matches;
  const N = reduce ? Math.ceil(count*0.3) : count;
  for(let i=0;i<N;i++){
    coins.push({
      x: w/2 + (Math.random()*160-80),
      y: h*0.34 + (Math.random()*60-30),
      vx:(Math.random()*5-2.5), vy:(Math.random()*-5-2),
      g: .22 + Math.random()*.06,
      r: Math.random()*Math.PI*2, vr: Math.random()*.2 - .1,
      size: 9 + Math.random()*10
    });
  }
  if(!coinRAF){
    const step=()=>{
      coinCtx.clearRect(0,0,coinCanvas.width, coinCanvas.height);
      coins.forEach(c=>{
        c.vy+=c.g; c.x+=c.vx; c.y+=c.vy; c.r+=c.vr;
        coinCtx.save(); coinCtx.translate(c.x,c.y); coinCtx.rotate(c.r);
        const s=c.size;
        const grd=coinCtx.createLinearGradient(-s, -s, s, s);
        grd.addColorStop(0, '#fff3b3'); grd.addColorStop(.5, '#ffd766'); grd.addColorStop(1, '#cc9f2a');
        coinCtx.fillStyle=grd;
        coinCtx.beginPath(); coinCtx.ellipse(0,0,s, s*0.74, 0, 0, Math.PI*2); coinCtx.fill();
        coinCtx.restore();
      });
      coins = coins.filter(c=> c.y < coinCanvas.height + 70);
      if(coins.length>0) coinRAF=requestAnimationFrame(step); else { cancelAnimationFrame(coinRAF); coinRAF=null; }
    };
    coinRAF=requestAnimationFrame(step);
  }
}

/* ================ Part√≠culas: Confeti ================ */
const confettiCanvas=document.getElementById('confetti');
const cctx=confettiCanvas.getContext('2d');
let conf=[], confRAF=null;
function resizeConf(){ confettiCanvas.width=innerWidth; confettiCanvas.height=innerHeight; }
addEventListener('resize', resizeConf); resizeConf();

function confetti(count=140){
  const w=confettiCanvas.width, h=confettiCanvas.height;
  const reduce = matchMedia('(prefers-reduced-motion: reduce)').matches;
  const N = reduce ? Math.ceil(count*0.3) : count;
  for(let i=0;i<N;i++){
    conf.push({
      x:w/2+(Math.random()*120-60),
      y:h*.32+(Math.random()*40-20),
      vx:(Math.random()*6-3),
      vy:(Math.random()*-6-2),
      g:.18+Math.random()*.06,
      a:Math.random()*Math.PI*2, va:Math.random()*.2-.1,
      size:6+Math.random()*6,
      shape: Math.random()<.5?'rect':'circle',
      col: ['#ffd24a','#fff4b0','#8fd0ff','#ff8ad6','#a6ffe9','#ffffff'][Math.floor(Math.random()*6)]
    });
  }
  if(!confRAF){
    const step=()=>{
      cctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
      conf.forEach(p=>{
        p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.a+=p.va;
        cctx.save(); cctx.translate(p.x,p.y); cctx.rotate(p.a);
        cctx.fillStyle=p.col;
        if(p.shape==='rect') cctx.fillRect(-p.size/2,-p.size/2,p.size,p.size*.6);
        else { cctx.beginPath(); cctx.arc(0,0,p.size*.45,0,Math.PI*2); cctx.fill(); }
        cctx.restore();
      });
      conf=conf.filter(p=> p.y < confettiCanvas.height+40);
      if(conf.length>0) confRAF=requestAnimationFrame(step); else { cancelAnimationFrame(confRAF); confRAF=null; }
    };
    confRAF=requestAnimationFrame(step);
  }
}

/* ================ Audio WebAudio (ligero, sin archivos) ================ */
const AudioEngine = ()=>{
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  let master = ctx.createGain(); master.gain.value = 0.7; master.connect(ctx.destination);
  const state = { spinNode:null, ambNode:null, muted:false };

  const env = (node, a=.008, d=.06, s=.4, r=.12, peak=0.9)=>{
    const now=ctx.currentTime; const g=node.gain;
    g.cancelScheduledValues(now);
    g.setValueAtTime(0, now);
    g.linearRampToValueAtTime(peak, now+a);
    g.linearRampToValueAtTime(peak*s, now+a+d);
    g.linearRampToValueAtTime(0, now+a+d+r);
  };

  const osc = (f, type='sine')=>{ const o=ctx.createOscillator(); o.type=type; o.frequency.value=f; return o; };
  const gain = (v=1)=>{ const g=ctx.createGain(); g.gain.value=v; return g; };

  const oneShot = (f, dur=.2, type='sine', vol=.7)=>{
    const o=osc(f,type); const g=gain(0); o.connect(g); g.connect(master); o.start(); env(g,.01,.06,.3,dur,vol); o.stop(ctx.currentTime+dur+.2);
  };

  const click = ()=> oneShot(880,.08,'square',.5);
  const lever = ()=> oneShot(220,.22,'sawtooth',.8);

  // Loop de giro (ruido filtrado + tono)
  const spinLoop = (on)=>{
    if(on){
      if(state.spinNode) return;
      const n=ctx.createBufferSource();
      const length = ctx.sampleRate*1;
      const buffer = ctx.createBuffer(1, length, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for(let i=0;i<length;i++) data[i] = (Math.random()*2-1)*0.35;
      n.buffer=buffer; n.loop=true;

      const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=900; bp.Q.value=0.9;
      const g=gain(0.0);
      n.connect(bp); bp.connect(g); g.connect(master);
      n.start(); g.gain.linearRampToValueAtTime(0.35, ctx.currentTime+.2);
      state.spinNode = { node:n, gain:g };
    }else if(state.spinNode){
      const {node,gain:g}=state.spinNode; g.gain.linearRampToValueAtTime(0, ctx.currentTime+.15);
      setTimeout(()=>{ try{ node.stop(); }catch{} state.spinNode=null; }, 220);
    }
  };

  const stopThunk = (i=0)=> oneShot(220+i*40,.12,'triangle',.9);

  // Jingles
  const chord = (notes=[880,1108,1318], dur=.5, vol=.8)=>{
    const gs = notes.map(f=>{ const o=osc(f,'square'); const g=gain(0); o.connect(g); g.connect(master); o.start(); env(g,.01,.06,.5,dur,vol); o.stop(ctx.currentTime+dur+.3); return g; });
    return gs;
  };
  const winPremio = ()=> { chord([740,988,1244],.38,.7); };
  const winJackpot = ()=> { chord([880,1108,1318],.5,.9); setTimeout(()=>chord([988,1244,1480],.5,.9),220); };

  // Ambiente suave (apagado por default hasta primer tap: aqu√≠ no loop para ahorrar)
  const ambience = (on)=>{
    if(on){
      if(state.ambNode) return;
      const o=osc(110,'sine'); const lfo=osc(2,'sine'); const g=gain(.05);
      const lg=gain(10); lfo.connect(lg.gain); lg.connect(o.frequency);
      o.connect(g); g.connect(master); o.start(); lfo.start();
      state.ambNode={o,lfo,g};
    }else if(state.ambNode){
      const {o,lfo,g}=state.ambNode; g.gain.linearRampToValueAtTime(0,ctx.currentTime+.2);
      setTimeout(()=>{ try{o.stop(); lfo.stop();}catch{} state.ambNode=null; }, 300);
    }
  };

  const setVolume = v => master.gain.value = v;
  const toggleMute = ()=>{
    state.muted = !state.muted;
    master.gain.value = state.muted ? 0 : volCtl.value;
    return state.muted;
  };

  return { click, lever, spinLoop, stopThunk, winPremio, winJackpot, ambience, setVolume, toggleMute, ctx };
};

let audio = null;
function setupAudioUI(){
  audio = AudioEngine();
  // Pol√≠tica autoplay: iniciar contexto en primer interacci√≥n
  const unlock = ()=>{ if (audio.ctx.state !== 'running'){ audio.ctx.resume(); } audio.ambience(true); window.removeEventListener('pointerdown', unlock); };
  window.addEventListener('pointerdown', unlock, {once:true});

  muteBtn.addEventListener('click', ()=>{
    const muted = audio.toggleMute();
    muteBtn.textContent = muted ? 'üîá' : 'üîä';
  });
  volCtl.addEventListener('input', e=> audio.setVolume(+e.target.value));
}

/* ================ SVG ICONS (detallados) ================ */
function sevenSVG(){
  return `
  <svg viewBox="0 0 64 64" aria-hidden="true">
    <defs>
      <linearGradient id="g1" x1="0" x2="0" y1="0" y2="1">
        <stop offset="0" stop-color="#fff6c9"/>
        <stop offset=".5" stop-color="#ffd766"/>
        <stop offset="1" stop-color="#cba22e"/>
      </linearGradient>
      <linearGradient id="edge" x1="0" x2="1">
        <stop offset="0" stop-color="#5a3e00"/><stop offset="1" stop-color="#b07a00"/>
      </linearGradient>
    </defs>
    <path d="M10 14h44v8L30 54H16l24-28H10z" fill="url(#g1)" stroke="url(#edge)" stroke-width="2" />
    <path d="M12 16h40v4L30 50h-8l20-24H12z" fill="rgba(255,255,255,.10)"/>
    <ellipse cx="32" cy="16" rx="18" ry="4" fill="rgba(255,255,255,.35)"/>
  </svg>`;}
function cherrySVG(){
  return `
  <svg viewBox="0 0 64 64">
    <defs>
      <radialGradient id="cr" cx=".35" cy=".3" r=".8">
        <stop offset="0" stop-color="#ffb3b3"/><stop offset=".5" stop-color="#ff4d4d"/><stop offset="1" stop-color="#b00018"/>
      </radialGradient>
      <linearGradient id="stem" x1="0" x2="0" y1="0" y2="1">
        <stop offset="0" stop-color="#89c46a"/><stop offset="1" stop-color="#2f6b2b"/>
      </linearGradient>
    </defs>
    <path d="M26 26c8-10 16-10 24-14" stroke="url(#stem)" stroke-width="3.5" fill="none"/>
    <circle cx="24" cy="42" r="10" fill="url(#cr)"/>
    <circle cx="40" cy="44" r="11" fill="url(#cr)"/>
    <ellipse cx="20" cy="38" rx="3" ry="2" fill="rgba(255,255,255,.6)"/>
    <ellipse cx="36" cy="40" rx="4" ry="2.2" fill="rgba(255,255,255,.6)"/>
  </svg>`;}
function lemonSVG(){
  return `
  <svg viewBox="0 0 64 64">
    <defs>
      <radialGradient id="lm" cx=".4" cy=".3" r=".9">
        <stop offset="0" stop-color="#fff5a8"/><stop offset=".5" stop-color="#ffd84a"/><stop offset="1" stop-color="#c8a400"/>
      </radialGradient>
      <linearGradient id="leaf" x1="0" x2="1">
        <stop offset="0" stop-color="#6adf7a"/><stop offset="1" stop-color="#2a8a3b"/>
      </linearGradient>
    </defs>
    <ellipse cx="36" cy="36" rx="18" ry="12" fill="url(#lm)" />
    <path d="M14 28c6 4 8 12 0 16 4-10 0-12 0-16z" fill="url(#lm)"/>
    <ellipse cx="44" cy="30" rx="8" ry="3" fill="rgba(255,255,255,.45)"/>
    <path d="M28 20c3 1 6 1 8 0" stroke="url(#leaf)" stroke-width="4" />
  </svg>`;}
function plumSVG(){
  return `
  <svg viewBox="0 0 64 64">
    <defs>
      <radialGradient id="pl" cx=".35" cy=".3" r=".9">
        <stop offset="0" stop-color="#ffd4ff"/><stop offset=".5" stop-color="#b56dff"/><stop offset="1" stop-color="#6b1d9e"/>
      </radialGradient>
      <linearGradient id="plleaf" x1="0" x2="1"><stop offset="0" stop-color="#7fe17f"/><stop offset="1" stop-color="#2b7a34"/></linearGradient>
    </defs>
    <ellipse cx="34" cy="40" rx="14" ry="12" fill="url(#pl)"/>
    <ellipse cx="28" cy="34" rx="6" ry="5" fill="rgba(255,255,255,.35)"/>
    <path d="M30 22c6-2 10-2 16-6" stroke="url(#plleaf)" stroke-width="4" />
  </svg>`;}
function kiwiSVG(){
  return `
  <svg viewBox="0 0 64 64">
    <defs>
      <radialGradient id="kw" cx=".4" cy=".35" r=".9">
        <stop offset="0" stop-color="#eaffc4"/><stop offset=".6" stop-color="#9ee36f"/><stop offset="1" stop-color="#4f7d2c"/>
      </radialGradient>
    </defs>
    <circle cx="34" cy="36" r="14" fill="url(#kw)" stroke="#2f4f1f" stroke-width="2"/>
    <circle cx="34" cy="36" r="4" fill="#2d3d1f"/>
    <g fill="#2d3d1f">
      <rect x="34" y="22" width="1.5" height="6"/><rect x="34" y="44" width="1.5" height="6"/>
      <rect x="22" y="36" width="6" height="1.5"/><rect x="44" y="36" width="6" height="1.5"/>
    </g>
  </svg>`;}
function starSVG(){
  return `
  <svg viewBox="0 0 64 64">
    <defs>
      <linearGradient id="st" x1="0" x2="0" y1="0" y2="1">
        <stop offset="0" stop-color="#fff6c9"/><stop offset=".5" stop-color="#ffd766"/><stop offset="1" stop-color="#cba22e"/>
      </linearGradient>
    </defs>
    <path d="M32 10l6.5 13.2 14.6 2.1-10.6 10.3 2.5 14.5L32 43l-13 7 2.5-14.5L11 25.3l14.6-2.1z" fill="url(#st)" stroke="#a67910" stroke-width="2"/>
    <ellipse cx="32" cy="16" rx="10" ry="3" fill="rgba(255,255,255,.35)"/>
  </svg>`;}

/* ================ Part√≠culas y Confeti (id√©ntico a versi√≥n previa) ================ */
// (ya incluido arriba)

/* ================ Audio UI ya inicializado arriba ================ */

/* ================ Helpers base ya definidos arriba ================ */
</script>
</body>
</html>
