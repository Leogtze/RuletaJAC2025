<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
<title>Tragamonedas JAC â€” V15 CALCADO CC0 embebido</title>
<style>
:root{
  --bg1:#080114; --bg2:#330a60; --bg3:#0b031d; --gold:#ffd76a; --gold2:#ffb200;
  --cyan:#7df9ff; --magenta:#ff28d0; --violet:#8a3dff; --hot:#ff3b7a;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{margin:0;height:100%;background:radial-gradient(160% 160% at 50% -20%, var(--bg2), var(--bg1) 40%, var(--bg3));
  color:#eee;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;overflow:hidden}
body{display:flex}
canvas{position:fixed;inset:0;width:100%;height:100%;z-index:1;touch-action:none;image-rendering:auto}
.wrap{position:fixed;inset:0;z-index:3;display:flex;flex-direction:column;justify-content:space-between;
  padding:10px 12px calc(env(safe-area-inset-bottom,0) + 14px);pointer-events:none}
header{display:flex;align-items:center;justify-content:space-between;gap:10px;pointer-events:auto}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:40px;height:40px;border-radius:14px;background:conic-gradient(from 0deg,var(--gold),#fff6b8,var(--gold2),var(--gold));
  box-shadow:0 0 18px rgba(255,215,106,.6), inset 0 0 12px rgba(0,0,0,.65);display:grid;place-items:center}
.logo span{filter:drop-shadow(0 2px 2px rgba(0,0,0,.8));font-size:24px}
h1{margin:0;font-size:18px;letter-spacing:1px;background:linear-gradient(90deg,#fff,var(--gold));-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 16px rgba(255,215,106,.4)}
.hud{display:flex;align-items:center;gap:8px}
.pill{font-weight:800;color:var(--gold);font-size:12px;padding:6px 10px;border-radius:999px;border:1.6px solid rgba(255,215,106,.8);
  background:rgba(255,215,106,.10);box-shadow:inset 0 0 12px rgba(255,215,106,.18)}
.toggle{appearance:none;border:1.6px solid rgba(255,215,106,.8);background:rgba(0,0,0,.35);color:#fff;border-radius:999px;
  padding:6px 10px;font-size:12px;display:flex;align-items:center;gap:6px;cursor:pointer}
.controls{display:flex;align-items:center;justify-content:center;margin-top:auto;pointer-events:auto}
.btn{--size:118px;width:var(--size);height:var(--size);border-radius:999px;border:none;cursor:pointer;position:relative;display:grid;place-items:center;
  background:radial-gradient(120% 120% at 50% 0%, #4b0a99, #2a0a52 45%, #180634);
  box-shadow:0 26px 40px rgba(0,0,0,.82), inset 0 0 32px rgba(255,215,106,.26), 0 0 34px rgba(250,80,255,.45);
  border:2px solid rgba(255,215,106,.95); color:#fff; font-weight:900; letter-spacing:1px; text-transform:uppercase; font-size:18px}
.btn span{position:relative;z-index:2;text-shadow:0 2px 0 rgba(0,0,0,.6),0 0 14px rgba(255,215,106,.55)}
.btn::before{content:"";position:absolute;inset:-8px;border-radius:inherit;background:conic-gradient(from 0deg, rgba(255,215,106,.0), rgba(255,215,106,.85), rgba(255,215,106,.0));filter:blur(10px);animation:spinRing 2.2s linear infinite;opacity:.95}
.btn:active{transform:translateY(1px) scale(.985)}
.btn[disabled]{opacity:.55;filter:grayscale(.25);cursor:not-allowed}
@keyframes spinRing{to{transform:rotate(1turn)}}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(5,3,12,.82);backdrop-filter:blur(5px);z-index:5}
.modal.show{display:flex}
.card{min-width:74%;max-width:520px;padding:24px 18px 18px;border-radius:24px;border:2px solid rgba(255,215,106,.98);
  background:radial-gradient(120% 140% at 50% 0%, rgba(255,255,255,.12), rgba(255,255,255,.05));
  box-shadow:0 24px 56px rgba(0,0,0,.9), inset 0 0 140px rgba(255,215,106,.18);text-align:center;position:relative;overflow:hidden}
.card::after{content:"";position:absolute;inset:0;background:radial-gradient(140% 70% at 50% -10%, rgba(255,255,255,.18), transparent 40%)}
.card h2{margin:0 0 8px;background:linear-gradient(90deg,var(--gold),#fff,var(--gold));-webkit-background-clip:text;background-clip:text;color:transparent;
  font-size:30px;letter-spacing:1.6px;text-shadow:0 0 24px rgba(255,215,106,.4)}
.card p{margin:0 0 16px;opacity:.96}
.ok{margin-top:6px;padding:10px 20px;border-radius:999px;border:1.6px solid rgba(255,215,106,.95);background:rgba(0,0,0,.68);color:#fff;font-size:14px;cursor:pointer}
.orient{position:fixed;inset:0;background:#070312;color:#eee;display:none;align-items:center;justify-content:center;z-index:6;text-align:center;padding:24px}
.orient.show{display:flex}
.loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:7;background:rgba(9,0,18,.92);backdrop-filter:blur(3px)}
.loader .dot{width:12px;height:12px;border-radius:999px;background:#ffd76a;margin:0 6px;filter:drop-shadow(0 0 8px #ffd76a);animation:b 1.1s infinite}
.loader .dot:nth-child(2){animation-delay:.15s}.loader .dot:nth-child(3){animation-delay:.3s}
@keyframes b{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-8px)}}
.badge{position:fixed;right:10px;bottom:10px;z-index:8;font-size:10px;opacity:.5}
</style>
</head>
<body>
<canvas id="stage" aria-label="MÃ¡quina tragamonedas"></canvas>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo"><span>ðŸš—</span></div>
      <h1>Tragamonedas JAC</h1>
    </div>
    <div class="hud">
      <div id="counter" class="pill" aria-live="polite">Tiradas restantes: 10</div>
      <button id="sound" class="toggle" aria-pressed="true"><span>ðŸ”Š</span><span>Sonido</span></button>
    </div>
  </header>
  <div class="controls">
    <button id="spin" class="btn" disabled><span>Girar</span></button>
  </div>
</div>
<div class="modal" id="win"><div class="card"><h2>Â¡PREMIO!</h2><p>5 sÃ­mbolos iguales en la lÃ­nea central.</p><button class="ok" data-close="#win">Aceptar</button></div></div>
<div class="modal" id="jack"><div class="card"><h2>ðŸŽ‰ Â¡PREMIO MAYOR! ðŸŽ‰</h2><p>Se activa el modo especial con 5 tiradas automÃ¡ticas culminando en 5 iguales.</p><button class="ok" data-close="#jack">Continuar</button></div></div>
<div class="orient" id="orient"><div><h3>Gira tu telÃ©fono</h3><p>Este juego estÃ¡ optimizado para orientaciÃ³n vertical.</p></div></div>
<div class="loader" id="loader" aria-live="polite"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
<div class="badge">V15 CC0 embebido</div>

<script>
/* =================== CONFIG =================== */
const ROWS=3, COLS=5, PAYLINE=1, MAX_SPINS=10;
const JACKPOT_PROB=0.05, WIN_PROB=0.10;
const SYMS=['sedan','suv','pickup','volante','veloc','llaves','bateria','estrella','bono','test'];

/* =================== CANVAS =================== */
const cvs = document.getElementById('stage'); const ctx = cvs.getContext('2d');
let W=innerWidth, H=innerHeight, DPR=window.devicePixelRatio||1;
function resize(){ W=innerWidth; H=innerHeight; DPR=window.devicePixelRatio||1; cvs.width=W*DPR; cvs.height=H*DPR; cvs.style.width=W+'px'; cvs.style.height=H+'px'; }
addEventListener('resize', resize); addEventListener('orientationchange', resize); resize();

function orientCheck(){ const land = matchMedia('(orientation: landscape)').matches; document.getElementById('orient').classList.toggle('show', land); }
addEventListener('resize', orientCheck); addEventListener('orientationchange', orientCheck); orientCheck();

let reel={x:0,y:0,w:0,h:0,cellH:0,cellW:0};
function layout(){ const w = Math.min(640, W*0.94); const h = Math.min(620, H*0.68); reel={ x:(W-w)/2, y:(H-h)/2-18, w, h, cellH:(h-22)/3, cellW:(w-44)/COLS }; }
layout();

/* =================== ATLAS PNG EMBEBIDO (generado on-the-fly) =================== */
const atlas = { img:null, map:{} };
function roundRectPath(g,x,y,w,h,r){ g.beginPath(); g.moveTo(x+r,y); g.arcTo(x+w,y,x+w,y+h,r); g.arcTo(x+w,y+h,x,y+h,r); g.arcTo(x,y+h,x,y,r); g.arcTo(x,y,x+w,y,r); g.closePath(); }
function drawBevel(g,x,y,w,h,r){
  const grad = g.createLinearGradient(0,0,0,h);
  grad.addColorStop(0,'#fff5c9'); grad.addColorStop(.18,'#ffd76a'); grad.addColorStop(.42,'#8f5f00'); grad.addColorStop(.6,'#ffe39a'); grad.addColorStop(.78,'#b97d00'); grad.addColorStop(1,'#fff2b0');
  g.fillStyle=grad; roundRectPath(g,x,y,w,h,r); g.fill();
  g.strokeStyle='#ffd76a'; g.lineWidth=3; roundRectPath(g,x,y,w,h,r); g.stroke();
  const grd = g.createLinearGradient(x,y,x+w,y+h);
  grd.addColorStop(0,'rgba(255,255,255,.0)'); grd.addColorStop(.5,'rgba(255,255,255,.22)'); grd.addColorStop(1,'rgba(255,255,255,0)');
  g.globalCompositeOperation='lighter'; g.fillStyle=grd;
  g.beginPath(); g.moveTo(x,y+h*.12); g.lineTo(x+w,y); g.lineTo(x+w,y+h*.28); g.lineTo(x,y+h*.40); g.closePath(); g.fill();
  g.globalCompositeOperation='source-over';
}
function drawIcon(g, cx, cy, id){
  const G='#ffd76a';
  g.save();
  g.translate(cx, cy+4);
  g.lineWidth=5; g.strokeStyle=G; g.fillStyle=G;
  const poly=(arr)=>{ g.beginPath(); g.moveTo(arr[0],arr[1]); for(let i=2;i<arr.length;i+=2) g.lineTo(arr[i],arr[i+1]); g.closePath(); g.stroke(); }
  const circ=(x,y,r,fill)=>{ g.beginPath(); g.arc(x,y,r,0,Math.PI*2); fill? g.fill(): g.stroke(); }
  const line=(x1,y1,x2,y2)=>{ g.beginPath(); g.moveTo(x1,y1); g.lineTo(x2,y2); g.stroke(); }
  const rrect=(x,y,w,h,r,fill=false)=>{ roundRectPath(g,x-w/2,y-h/2,w,h,r); fill? g.fill(): g.stroke(); }
  switch(id){
    case 'sedan': poly([-70,20,70,20,50,-20,0,-45,-40,-45,-65,-20]); circ(-40,28,12,true); circ(40,28,12,true); break;
    case 'suv': poly([-72,22,72,22,58,-18,5,-45,-40,-45,-62,-18]); circ(-42,30,11,true); circ(42,30,11,true); break;
    case 'pickup': poly([-75,20,75,20,75,-18,25,-18,0,-45,-35,-45,-55,-18,-75,-18]); circ(-42,30,11,true); circ(42,30,11,true); break;
    case 'volante': circ(0,0,50,false); circ(0,0,20,true); g.lineWidth=4; line(-35,0,35,0); line(-15,-20,-55,-30); line(15,-20,55,-30); break;
    case 'veloc': circ(0,10,44,false); g.lineWidth=6; line(0,10,26,-16); break;
    case 'llaves': circ(-20,-10,22,false); g.lineWidth=5; line(0,10,60,60); line(60,60,74,46); line(74,46,86,58); break;
    case 'bateria': rrect(0,0,110,60,10,false); g.fillRect(56,-16,8,32); line(0,-26,-18,14); line(-18,14,6,14); line(6,14,-10,44); break;
    case 'estrella': g.beginPath(); for(let i=0;i<10;i++){ const ang=-Math.PI/2 + i*(Math.PI/5); const r=(i%2?18:36); const x=Math.cos(ang)*r, y=Math.sin(ang)*r; i? g.lineTo(x,y): g.moveTo(x,y); } g.closePath(); g.fill(); break;
    case 'bono': rrect(0,0,120,56,12,false); break;
    case 'test': rrect(0,0,120,80,12,false); line(-40,-5,40,-5); line(-40,18,10,18); circ(42,18,10,true); break;
  }
  g.restore();
}
function buildAtlas(){
  const PAD=32, SIZE=256, COLS_ATLAS=5, ROWS_ATLAS=4;
  const c=document.createElement('canvas'); c.width=(SIZE+PAD)*COLS_ATLAS+PAD; c.height=(SIZE+PAD)*ROWS_ATLAS+PAD;
  const g=c.getContext('2d'); g.imageSmoothingQuality='high';
  let i=0;
  for(let r=0;r<ROWS_ATLAS;r++){
    for(let cidx=0;cidx<COLS_ATLAS;cidx++){
      const x=PAD + cidx*(SIZE+PAD), y=PAD + r*(SIZE+PAD);
      if(i<SYMS.length){
        // base + Ã­cono
        drawBevel(g, x, y, SIZE, SIZE, 28);
        drawIcon(g, x+SIZE/2, y+SIZE/2, SYMS[i]);
        atlas.map[SYMS[i]]={sx:x, sy:y, sw:SIZE, sh:SIZE};
      }else{
        // celdas libres (pueden usarse luego para "win")
        drawBevel(g, x, y, SIZE, SIZE, 28);
      }
      i++;
    }
  }
  // generar dataURL
  const img=new Image(); img.src=c.toDataURL('image/png');
  atlas.img=img;
}
/* =================== AUDIO CC0 GENERADO (WAV embebido) =================== */
function pcmToWavBase64(samples, sampleRate=44100){
  const numSamples=samples.length, numChannels=1, bytesPerSample=2;
  const blockAlign=numChannels*bytesPerSample, byteRate=sampleRate*blockAlign;
  const dataSize=numSamples*bytesPerSample, bufferSize=44+dataSize;
  const buf=new Uint8Array(bufferSize); const dv=new DataView(buf.buffer);
  let p=0; function w(s){ for(let i=0;i<s.length;i++) buf[p++]=s.charCodeAt(i); }
  w('RIFF'); dv.setUint32(p,36+dataSize,true); p+=4; w('WAVEfmt ');
  dv.setUint32(p,16,true); p+=4; dv.setUint16(p,1,true); p+=2; dv.setUint16(p,numChannels,true); p+=2;
  dv.setUint32(p,sampleRate,true); p+=4; dv.setUint32(p,byteRate,true); p+=4; dv.setUint16(p,blockAlign,true); p+=2; dv.setUint16(p,bytesPerSample*8,true); p+=2;
  w('data'); dv.setUint32(p,dataSize,true); p+=4;
  for(let i=0;i<numSamples;i++){ let s=Math.max(-1,Math.min(1,samples[i])); dv.setInt16(p, s<0?s*0x8000:s*0x7FFF, true); p+=2; }
  // base64
  let bin=''; for(let i=0;i<buf.length;i++) bin+=String.fromCharCode(buf[i]);
  return 'data:audio/wav;base64,' + btoa(bin);
}
function genNoise(lenSec=1.2, sr=44100, color='band', f=1600, Q=1.0){
  const n=lenSec*sr|0; const a=new Float32Array(n); for(let i=0;i<n;i++){ a[i]=Math.random()*2-1; }
  if(color==='band'){
    // Biquad bandpass simple (RBJ)
    const w0=2*Math.PI*f/sr, alpha=Math.sin(w0)/(2*Q), cosW=Math.cos(w0);
    const b0=alpha, b1=0, b2=-alpha, a0=1+alpha, a1=-2*cosW, a2=1-alpha;
    let x1=0,x2=0,y1=0,y2=0;
    for(let i=0;i<n;i++){ const x=a[i]; const y=(b0/a0)*x + (b1/a0)*x1 + (b2/a0)*x2 - (a1/a0)*y1 - (a2/a0)*y2; x2=x1;x1=x;y2=y1;y1=y; a[i]=y*0.6; }
  }
  // envelope
  const attack=0.02*sr|0, release=0.25*sr|0;
  for(let i=0;i<n;i++){ const env = i<attack ? (i/attack) : Math.max(0, 1 - (i-attack)/(n-attack)); a[i]*=env; }
  return a;
}
function genTone(lenSec=0.25, sr=44100, freq=440, type='tri'){
  const n=lenSec*sr|0; const a=new Float32Array(n);
  for(let i=0;i<n;i++){ const t=i/sr; let v=0; const ph=2*Math.PI*freq*t;
    if(type==='tri'){ v=2/Math.PI*Math.asin(Math.sin(ph)); }
    else if(type==='sqr'){ v = Math.sign(Math.sin(ph)); }
    else { v = Math.sin(ph); }
    // simple env
    const att=Math.min(1,i/(0.01*sr)); const rel=Math.max(0,(n-i)/(0.2*sr)); a[i]=v*0.3*att*rel;
  }
  return a;
}
const SND={};
function buildSounds(){
  // whoosh
  SND.spin = pcmToWavBase64(genNoise(1.6,44100,'band',1500,1.1));
  // tick
  SND.tick = pcmToWavBase64(genTone(0.06,44100,550,'sqr'));
  // stop
  let stop=genTone(0.14,44100,110,'tri'); const stop2=genTone(0.16,44100,55,'sin');
  for(let i=0;i<stop.length;i++){ stop[i]+= (stop2[i]||0)*0.8; } SND.stop=pcmToWavBase64(stop);
  // win arpeggio
  const w1=genTone(0.18,44100,660,'tri'), w2=genTone(0.18,44100,880,'sqr'); for(let i=0;i<w1.length;i++){ w1[i]+= (w2[i]||0)*0.6; }
  SND.win=pcmToWavBase64(w1);
  // jackpot fanfare
  const j1=genTone(0.3,44100,523.25,'sqr'), j2=genTone(0.3,44100,659.25,'tri'), j3=genTone(0.3,44100,783.99,'sqr');
  let fan=new Float32Array(j1.length+j2.length+j3.length); fan.set(j1,0); fan.set(j2,j1.length); fan.set(j3,j1.length+j2.length);
  SND.jack=pcmToWavBase64(fan);
  // coin rain
  const coins=genTone(0.06,44100,1600,'sqr'); SND.coins=pcmToWavBase64(coins);
}
function play(name){ if(!audioOn) return; const a=new Audio(SND[name]); a.play().catch(()=>{}); }

/* =================== REELS / ESTADO =================== */
const columns = Array.from({length:COLS}, (_,i)=>({ y:0, target:0, delay:i*120, renderY:0, v:0 }));
function decideOutcome(){ const r=Math.random(); if(r<JACKPOT_PROB) return 'JACKPOT'; if(r<JACKPOT_PROB+WIN_PROB) return 'WIN'; return 'NORMAL'; }
function pickId(){ return SYMS[(Math.random()*SYMS.length)|0] }

/* =================== ANIMACIÃ“N =================== */
const easeOutCubic = t => 1 - Math.pow(1-t,3);
const easeOutBack = t => { const c1=1.70158, c3=c1+1; return 1 + c3*Math.pow(t-1,3) + c1*Math.pow(t-1,2) };
function animateTo(col, to, dur, ease){ return new Promise(resolve=>{ const from=col.renderY||0; const t0=performance.now(); function step(ts){ const t=Math.min(1,(ts-t0)/dur); const prev=col.renderY; col.renderY = from + (to-from)*ease(t); col.v = col.renderY - prev; if(t<1) requestAnimationFrame(step); else resolve(); } requestAnimationFrame(step); }) }
async function spinTo(targetCenter){
  const stride = SYMS.length * reel.cellH;
  const base = 1420;
  play('spin');
  for(let i=0;i<COLS;i++){
    const col=columns[i];
    const chosen = targetCenter ? targetCenter[i] : pickId();
    const k = SYMS.indexOf(chosen);
    const loops = 6 + i;
    const dest = -(loops*stride + k*reel.cellH + PAYLINE*reel.cellH);
    await new Promise(r=>setTimeout(r, col.delay));
    col.renderY = col.renderY || -(Math.random()*stride);
    await animateTo(col, col.renderY - 24, 120, easeOutCubic);
    await animateTo(col, dest+12, base+i*120, easeOutCubic);
    await animateTo(col, dest, 140, easeOutBack); play('tick');
    if(i===COLS-1){ play('stop'); }
  }
}

/* =================== FX =================== */
const particles=[]; let bgPhase=0;
function spawnCoins(x,y,w){ for(let i=0;i<160;i++) particles.push({type:'coin',x:x+Math.random()*w,y:y-24-Math.random()*40, vx:(Math.random()*2-1)*1.6, vy:1+Math.random()*2.6, rot:Math.random()*Math.PI*2, vr:(Math.random()-.5)*.26, life:160+Math.random()*80}); }
function spawnConfetti(x,y,w){ for(let i=0;i<170;i++) particles.push({type:'conf',x:x+Math.random()*w,y:y-24-Math.random()*40, vx:(Math.random()*2-1)*1.7, vy:1+Math.random()*3.0, rot:Math.random()*Math.PI*2, vr:(Math.random()-.5)*.34, life:160+Math.random()*80}); }
function drawParticles(){
  // bokeh animado
  bgPhase+=0.005;
  for(let i=0;i<3;i++){ const px=W*(i*.3+.2+0.05*Math.sin(bgPhase+i)), py=H*(.25+.1*Math.cos(bgPhase*1.3+i)); radial(px,py,260+60*i,'rgba(255,40,208,.06)'); }
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.vy*=1.012; p.rot+=p.vr; p.life--;
    if(p.type==='coin'){
      ctx.save(); ctx.translate(p.x*DPR,p.y*DPR); ctx.rotate(p.rot);
      const r=8*DPR; const grd=ctx.createRadialGradient(-r*.2,-r*.2, r*.2, 0,0,r);
      grd.addColorStop(0,'#fff'); grd.addColorStop(.5,'#ffd76a'); grd.addColorStop(1,'#b57b00');
      ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill(); ctx.restore();
    } else {
      ctx.save(); ctx.translate(p.x*DPR,p.y*DPR); ctx.rotate(p.rot);
      ctx.fillStyle='rgba(255,40,208,.92)'; ctx.fillRect(-3*DPR,-5*DPR,6*DPR,10*DPR); ctx.restore();
    }
    if(p.life<=0) particles.splice(i,1);
  }
}
let payFlash=0; function triggerPayFlash(){ payFlash=1; }
let ledPhase=0;
function drawPayline(){
  for(let i=3;i>=1;i--){ ctx.strokeStyle=`rgba(125,249,255,${.12*i + (payFlash*0.35)})`; ctx.lineWidth=i+1; line(reel.x+12, reel.y + reel.cellH*PAYLINE + 10, reel.x+reel.w-12, reel.y + reel.cellH*PAYLINE + 10); }
  payFlash *= .85;
}
function drawLEDs(){
  const step=14, r=3.2*DPR;
  for(let x=reel.x-12; x<reel.x+reel.w+12; x+=step){
    const t=((x+ledPhase)/step)%1; const a=.3+.7*Math.max(0,Math.cos(t*Math.PI*2));
    dot(x, reel.y-16, r, a);
    dot(x, reel.y+reel.h+16, r, a*.9);
  }
  for(let y=reel.y-12; y<reel.y+reel.h+12; y+=step){
    const t=((y+ledPhase)/step)%1; const a=.3+.7*Math.max(0,Math.cos(t*Math.PI*2));
    dot(reel.x-16, y, r, a*.9);
    dot(reel.x+reel.w+16, y, r, a*.9);
  }
  ledPhase += 1.0;
}
function dot(x,y,r,a){
  ctx.save(); ctx.translate(x*DPR,y*DPR);
  const g=ctx.createRadialGradient(0,0,0,0,0,r*2.2); g.addColorStop(0,`rgba(255,215,106,${.7*a})`); g.addColorStop(1,'rgba(255,215,106,0)');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,r*2.2,0,Math.PI*2); ctx.fill();
  ctx.fillStyle=`rgba(255,215,106,${.95*a})`; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
  ctx.restore();
}

/* =================== HELPERS =================== */
function line(x1,y1,x2,y2){ ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); }
function roundRect(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
function radial(x,y,r,fill){ ctx.save(); ctx.translate(x*DPR,y*DPR); const g=ctx.createRadialGradient(0,0,0,0,0,r*DPR); g.addColorStop(0,fill); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,r*DPR,0,Math.PI*2); ctx.fill(); ctx.restore(); }

/* =================== DRAW LOOP =================== */
let winCount=0, winCountTarget=0;
function draw(){
  ctx.setTransform(DPR,0,0,DPR,0,0);
  ctx.clearRect(0,0,W,H);
  // marco y viÃ±eta
  ctx.save();
  ctx.strokeStyle='#ffd76a'; ctx.lineWidth=6; roundRect(reel.x-20,reel.y-20,reel.w+40,reel.h+40,30); ctx.stroke();
  ctx.globalAlpha=.9; ctx.strokeStyle='rgba(255,255,255,.08)'; ctx.lineWidth=3; roundRect(reel.x,reel.y,reel.w,reel.h,24); ctx.stroke();
  ctx.restore();
  drawParticles();
  drawLEDs();
  drawPayline();
  // ventana con atlas
  ctx.save(); roundRect(reel.x,reel.y,reel.w,reel.h,24); ctx.clip();
  for(let c=0;c<COLS;c++){
    const col=columns[c];
    const baseX = reel.x + c*(reel.w/COLS);
    const yOffset = col.renderY ?? col.y;
    const blurSamples = Math.min(6, Math.max(1, Math.ceil(Math.abs(col.v)/3)));
    for(let s=0;s<blurSamples;s++){
      const lerp = s/(blurSamples-1||1);
      const yL = yOffset - col.v*lerp*0.5;
      const alpha = 1 - lerp*0.85;
      ctx.globalAlpha = alpha;
      const startY = Math.floor((-yL - reel.cellH*2)/reel.cellH)*reel.cellH;
      for(let y=startY; y<(-yL + reel.h + reel.cellH*2); y+=reel.cellH){
        const rowIndex = Math.floor((y/reel.cellH) % SYMS.length); const id = SYMS[(rowIndex+SYMS.length)%SYMS.length];
        const slot = atlas.map[id]; const dw = Math.round(reel.cellW-16), dh=Math.round(reel.cellH-8);
        ctx.drawImage(atlas.img, slot.sx, slot.sy, slot.sw, slot.sh, Math.round(baseX+8), Math.round(y + yL + reel.y + 10), dw, dh);
      }
    }
    ctx.globalAlpha = 1;
    if(Math.abs(col.v)<0.4){
      const sy = reel.y + reel.cellH*PAYLINE + 10;
      const sx = (Date.now()/4 + c*160) % (reel.cellW);
      const grd=ctx.createLinearGradient(baseX+sx-80,sy, baseX+sx+80, sy+reel.cellH-8);
      grd.addColorStop(0,'rgba(255,255,255,0)'); grd.addColorStop(.5,'rgba(255,255,255,.18)'); grd.addColorStop(1,'rgba(255,255,255,0)');
      ctx.fillStyle=grd; ctx.fillRect(baseX+8, sy, reel.cellW-16, reel.cellH-8);
    }
  }
  ctx.restore();
  if(winCount < winCountTarget){ winCount += Math.max(1, Math.floor((winCountTarget-winCount)*0.12)); }
  if(winCount>0){
    ctx.save(); ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font=`700 ${Math.max(18, Math.min(42, W*0.08))}px system-ui`; ctx.fillStyle='rgba(255,215,106,.95)';
    ctx.shadowColor='rgba(255,215,106,.7)'; ctx.shadowBlur=18;
    ctx.fillText(`Premio: ${winCount}`, W/2, reel.y - 28);
    ctx.restore();
  }
  requestAnimationFrame(draw);
}
requestAnimationFrame(draw);

/* =================== GAME =================== */
const btn=document.getElementById('spin'); const toggleSound=document.getElementById('sound'); const modalWin=document.getElementById('win'); const modalJack=document.getElementById('jack'); const loader=document.getElementById('loader');
function show(m){ m.classList.add('show') } function hide(m){ m.classList.remove('show') }
document.querySelectorAll('[data-close]').forEach(b=> b.addEventListener('click', e=>{ const sel=e.currentTarget.getAttribute('data-close'); const m=document.querySelector(sel); if(m) hide(m) }));
function vibrate(p){ if(navigator.vibrate) navigator.vibrate(p) }

let spinsLeft=MAX_SPINS, spinning=false, inJackpot=false, preloadDone=false;
const counterEl=document.getElementById('counter'); function updateCounter(){ counterEl.textContent=`Tiradas restantes: ${spinsLeft}` } updateCounter();

async function doSpin(manual=true){
  if(spinning || !preloadDone) return;
  if(manual){ if(spinsLeft<=0) return; spinsLeft--; updateCounter(); }
  spinning=true; btn.disabled=true;
  let outcome='NORMAL'; if(manual && !inJackpot) outcome = decideOutcome();
  if(outcome==='JACKPOT' && !inJackpot){
    inJackpot=true; play('jack'); show(modalJack); vibrate([80,40,120]); setTimeout(()=>hide(modalJack),900);
    for(let i=1;i<=5;i++){
      let target=null;
      if(i===5){ const id=pickId(); target=Array(COLS).fill(id) }
      else { const id=pickId(); const same=2 + (Math.random()*2|0); target=Array(COLS).fill(null).map((_,k)=> k<same? id : pickId()) }
      play('spin'); await spinTo(target);
      if(i<5) for(let k=0;k<4+i;k++) play('coins');
      await new Promise(r=>setTimeout(r, 120 + i*70));
    }
    for(let k=0;k<10;k++) play('coins');
    spawnCoins(reel.x, reel.y, reel.w); triggerPayFlash(); vibrate(220);
    winCountTarget += 100;
    show(modalJack);
    inJackpot=false; spinning=false; btn.disabled = spinsLeft<=0; if(spinsLeft<=0){ btn.innerHTML='<span>Sin tiradas</span>'; } return;
  }
  let target=null; if(outcome==='WIN'){ const id=pickId(); target=Array(COLS).fill(id) }
  play('spin'); await spinTo(target);
  if(outcome==='WIN'){ play('win'); spawnConfetti(reel.x, reel.y, reel.w); triggerPayFlash(); vibrate([60,40,60]); winCountTarget += 25; show(modalWin); }
  spinning=false; btn.disabled = spinsLeft<=0; if(spinsLeft<=0){ btn.innerHTML='<span>Sin tiradas</span>'; }
}

/* ========= Preload ========= */
function prewarm(){
  // Atlas
  buildAtlas();
  // Audio
  buildSounds();
  // Ready
  preloadDone=true; loader.style.display='none'; btn.disabled=false;
}
setTimeout(prewarm, 60);

/* ========= UI ========= */
let audioOn=true;
btn.addEventListener('click', ()=>doSpin(true));
const toggleSound=document.getElementById('sound');
toggleSound.addEventListener('click', ()=>{
  audioOn=!audioOn; toggleSound.setAttribute('aria-pressed', audioOn?'true':'false');
  toggleSound.innerHTML = audioOn? '<span>ðŸ”Š</span><span>Sonido</span>' : '<span>ðŸ”‡</span><span>Silencio</span>';
  if(audioOn){ const a=new Audio(SND.win||''); a.play().catch(()=>{}); }
});

/* ========= Touch ========= */
document.addEventListener('touchmove', (e)=>{ if(e.touches.length===1) e.preventDefault() }, {passive:false});
</script>
</body>
</html>

