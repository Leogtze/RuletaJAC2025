<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ruleta de Premios</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --brand:#d61f26; --bg:#070a12; --bg2:#0c1426; --gold:#f6e05e; --gold2:#f59e0b; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
      color:#e5e7eb;background:
        radial-gradient(1200px 800px at 50% -200px, #16233f 0%, var(--bg2) 40%, var(--bg) 100%),
        linear-gradient(180deg, #0a0f1b 0%, #070a12 100%);
      display:grid;place-items:center;overflow:hidden;
    }
    .stage{position:relative;width:min(92vw,780px)}
    .panel{position:relative;padding:28px 20px 22px;border-radius:22px;background:linear-gradient(180deg,#ffffff12,#ffffff08);border:1px solid #ffffff20;box-shadow:0 30px 80px #0008,inset 0 1px 0 #ffffff22}
    .glow{position:absolute;inset:-10%;filter:blur(60px);opacity:.35;pointer-events:none;background:conic-gradient(from 180deg at 50% 50%,#00aaff10,#ff00aa10,#ffaa0010,#00ffaa10,#00aaff10);border-radius:24px;animation:slowspin 20s linear infinite}
    @keyframes slowspin{to{transform:rotate(360deg)}}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .header h1{margin:0;font-size:22px;letter-spacing:.3px}
    .tries{font-size:14px;opacity:.9}
    .wrap{position:relative;display:grid;place-items:center}
    canvas#wheel{width:min(86vw,680px);height:min(86vw,680px);display:block;filter:drop-shadow(0 40px 60px #0008)}

    /* Flecha/puntero visible */
    .pointer{position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:0;height:0;z-index:4;
      border-left:22px solid transparent;border-right:22px solid transparent;border-bottom:38px solid #f8fafc;
      filter:drop-shadow(0 2px 8px #0009);}
    .pointer::after{content:"";position:absolute;left:-19px;top:6px;width:38px;height:22px;border-radius:12px 12px 2px 2px;background:linear-gradient(180deg,#cbd5e1,#94a3b8);box-shadow:inset 0 1px 0 #fff8}
    .rivet{position:absolute;top:20px;left:50%;transform:translateX(-50%);width:10px;height:10px;border-radius:50%;background:#0b1220;border:2px solid #e2e8f0;z-index:5}

    .cta{margin-top:16px;display:flex;justify-content:center;gap:10px}
    #spin{appearance:none;border:none;cursor:pointer;padding:14px 22px;font-weight:700;letter-spacing:.3px;color:white;background:linear-gradient(180deg,#f43f5e,#d61f26);border-radius:14px;box-shadow:0 16px 40px #d61f2640,inset 0 1px 0 #ffffff66;transition:transform .08s ease,box-shadow .2s ease}
    #spin:hover{transform:translateY(-1px);box-shadow:0 22px 50px #d61f2660,inset 0 1px 0 #fff8}

    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#0b1220cc;border:1px solid #ffffff26;padding:10px 14px;border-radius:12px;font-size:15px;display:none}
    #fx{position:fixed;inset:0;pointer-events:none}

    /* Modal FELICIDADES */
    .modal{position:fixed;inset:0;background:#0009;backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
    .box{background:linear-gradient(180deg,#1f2937,#0f172a);border:1px solid #ffffff22;border-radius:18px;max-width:520px;width:100%;padding:22px;box-shadow:0 30px 80px #000c}
    .box h2{margin:0 0 6px;font-size:28px;letter-spacing:1px;text-align:center;color:#fff}
    .box p{margin:4px 0 14px;text-align:center;color:#cbd5e1}
    .marquee{display:flex;gap:8px;justify-content:center;margin:8px 0 14px}
    .bulb{width:12px;height:12px;border-radius:50%;background:#ffd166;box-shadow:0 0 14px #ffd16688}
    .close{display:block;margin:0 auto;appearance:none;border:1px solid #ffffff22;background:#111827;color:#e5e7eb;padding:10px 14px;border-radius:12px;font-weight:600}

    /* Brillo de cristal */
    .glass{position:absolute;inset:auto;width:60%;height:50%;top:8%;left:20%;pointer-events:none;border-radius:50%;background:radial-gradient(90% 50% at 50% 0%,#ffffff22,transparent 60%);filter:blur(6px);transform:rotate(-12deg)}
  </style>
</head>
<body>
  <div class="stage">
    <div class="glow"></div>
    <div class="panel">
      <div class="header">
        <h1>Ruleta de Premios</h1>
        <div class="tries" id="tries">Intento 1/3</div>
      </div>
      <div class="wrap">
        <div class="pointer"></div>
        <div class="rivet"></div>
        <canvas id="wheel" width="720" height="720" aria-label="ruleta"></canvas>
        <div class="glass"></div>
      </div>
      <div class="cta"><button id="spin">Girar ahora</button></div>
    </div>
  </div>
  <canvas id="fx"></canvas>
  <div class="toast" id="toast"></div>

  <!-- Modal Felicidades -->
  <section class="modal" id="winModal">
    <div class="box">
      <div class="marquee">
        <span class="bulb"></span><span class="bulb"></span><span class="bulb"></span><span class="bulb"></span><span class="bulb"></span><span class="bulb"></span>
      </div>
      <h2>Â¡FELICIDADES!</h2>
      <p id="winText">Has obtenido un premio.</p>
      <div class="marquee">
        <span class="bulb"></span><span class="bulb"></span><span class="bulb"></span><span class="bulb"></span><span class="bulb"></span><span class="bulb"></span>
      </div>
      <button class="close" id="closeWin">Cerrar</button>
    </div>
  </section>

  <script>
    // ===== Config con estilo slot / Las Vegas =====
    // 4 iconos tipo slot + 4 PREMIO ESPECIAL (uno es JACKPOT) + 3 BONOS
    // Tipos: icon, bonus, special, jackpot (para jerarquÃ­a y estilos)
    const PRIZES = [
      { label:"ðŸ’", type:"icon", color:"#ef4444", weight:3 },
      { label:"ðŸ‹", type:"icon", color:"#f59e0b", weight:3 },
      { label:"ðŸ“", type:"icon", color:"#e11d48", weight:3 },
      { label:"â­", type:"icon", color:"#fbbf24", weight:3 },

      { label:"PREMIO ESPECIAL", type:"special", color:"#f59e0b", weight:1 },
      { label:"PREMIO ESPECIAL", type:"special", color:"#f59e0b", weight:1 },
      { label:"PREMIO ESPECIAL", type:"special", color:"#f59e0b", weight:1 },
      { label:"PREMIO ESPECIAL MAYOR", type:"jackpot", color:"#f6e05e", weight:1 },

      { label:"BONO ADICIONAL", type:"bonus", color:"#22c55e", weight:2 },
      { label:"BONO ADICIONAL", type:"bonus", color:"#0ea5e9", weight:2 },
      { label:"BONO ADICIONAL", type:"bonus", color:"#a855f7", weight:2 },
    ];

    const MAX_TRIES = 3;
    const storeKey = 'ruleta_slot_v1';
    const state = JSON.parse(localStorage.getItem(storeKey) || 'null') || { tries:0, bestTier:0, bestText:'' };

    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    const fx = document.getElementById('fx');
    const fctx = fx.getContext('2d');
    const TAU = Math.PI*2; const R = canvas.width/2;

    let angle = 0, angVel = 0, angAcc = 0, spinning=false, targetIndex=null;

    // ===== Util =====
    const clamp=(n,min,max)=>Math.min(max,Math.max(min,n));
    function weightedIndex(items){
      const total = items.reduce((s,p)=>s+(p.weight||1),0);
      let r = Math.random()*total;
      for(let i=0;i<items.length;i++){ r -= (items[i].weight||1); if(r<=0) return i; }
      return items.length-1;
    }
    function tierOf(p){ return p.type==="jackpot"?4: p.type==="special"?3: p.type==="bonus"?2: 1; }

    // ===== Dibujo con profundidad + MARQUEE de focos =====
    function drawWheel(a){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.save(); ctx.translate(R,R); ctx.rotate(a);
      const n=PRIZES.length, slice=TAU/n, rim=10;

      // sombra
      ctx.beginPath(); ctx.arc(0,0,R-2,0,TAU);
      const shadow = ctx.createRadialGradient(0,0,R*0.3, 0,0,R);
      shadow.addColorStop(0,'#0002'); shadow.addColorStop(1,'#000a');
      ctx.fillStyle=shadow; ctx.fill();

      // aro metÃ¡lico
      ctx.beginPath(); ctx.arc(0,0,R-rim,0,TAU); ctx.arc(0,0,R-26,0,TAU,true); ctx.closePath();
      const ring = ctx.createLinearGradient(-R,0,R,0);
      ring.addColorStop(0,'#9fb3c8'); ring.addColorStop(.5,'#e5eef6'); ring.addColorStop(1,'#9fb3c8');
      ctx.fillStyle=ring; ctx.fill();

      // base
      ctx.beginPath(); ctx.arc(0,0,R-28,0,TAU); ctx.fillStyle='#0b1220'; ctx.fill();

      // segmentos
      for(let i=0;i<n;i++){
        ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,R-28,i*slice,(i+1)*slice); ctx.closePath();
        const base = PRIZES[i].type==='jackpot' ? '#f6e05e' : (PRIZES[i].type==='special' ? '#f59e0b' : PRIZES[i].color);
        const g = ctx.createRadialGradient(0,0,R*0.12, 0,0,R-28);
        g.addColorStop(0, shade(base,.22)); g.addColorStop(1, base);
        ctx.fillStyle=g; ctx.fill();
        ctx.strokeStyle= PRIZES[i].type==='jackpot' ? '#fff9' : '#fff3'; ctx.lineWidth= PRIZES[i].type==='jackpot'?3:2; ctx.stroke();

        // texto/icono muy legible
        ctx.save(); ctx.rotate(i*slice + slice/2); ctx.textAlign='center';
        const p=PRIZES[i];
        if(/^[\p{Emoji}\p{So}\p{Sk}\*\#]+$/u.test(p.label) || p.type==='icon'){
          ctx.font='700 64px Poppins';
          ctx.lineWidth=6; ctx.strokeStyle='rgba(0,0,0,.55)'; ctx.fillStyle='#fff';
          ctx.strokeText(p.label, R*0.58, 12); ctx.fillText(p.label, R*0.58, 12);
        } else {
          ctx.font = p.type==='jackpot' ? '700 28px Poppins' : '700 24px Poppins';
          ctx.lineWidth=5; ctx.strokeStyle='rgba(0,0,0,.65)'; ctx.fillStyle= p.type==='jackpot' ? '#111' : '#f8fafc';
          const txt = p.type==='jackpot' ? 'JACKPOT' : p.label;
          drawWrapped(txt, R*0.60, 28);
        }
        // adorno brillo para especiales
        if(p.type==='jackpot' || p.type==='special'){
          ctx.beginPath(); ctx.arc(R*0.40,0,6,0,TAU); ctx.fillStyle='#fff8'; ctx.fill();
        }
        ctx.restore();
      }

      // centro abombado + anillo rojo
      ctx.beginPath(); ctx.arc(0,0,R*0.16,0,TAU);
      const cap = ctx.createRadialGradient(-R*0.05,-R*0.05,2, 0,0,R*0.18);
      cap.addColorStop(0,'#ffffffdd'); cap.addColorStop(1,'#8b9bb0'); ctx.fillStyle=cap; ctx.fill();
      ctx.beginPath(); ctx.arc(0,0,R*0.22,0,TAU); ctx.lineWidth=10; ctx.strokeStyle='#d61f26'; ctx.stroke();

      ctx.restore();

      // Marquee de focos (no gira)
      drawBulbs();
    }

    function drawBulbs(){
      const bulbs=48; const radius=R-8; const cx = canvas.width/2, cy = canvas.height/2; const t = performance.now()/500;
      ctx.save();
      for(let i=0;i<bulbs;i++){
        const a = (i/bulbs)*TAU; const x = cx + Math.cos(a)*radius; const y = cy + Math.sin(a)*radius;
        const phase = (i%2===0? 0:0.5); const glow = (Math.sin(t+phase*TAU)*0.5+0.5);
        ctx.beginPath(); ctx.arc(x,y,4,0,TAU);
        const c = `rgba(255, ${180+glow*75|0}, 90, 1)`; // Ã¡mbar
        ctx.fillStyle=c; ctx.fill();
        ctx.shadowColor=`rgba(255,200,90,${0.6*glow})`; ctx.shadowBlur=8*glow; ctx.shadowOffsetX=0; ctx.shadowOffsetY=0;
        ctx.closePath();
      }
      ctx.restore();
    }

    function drawWrapped(text, radius, lineHeight){
      const words = text.split(' '); let line='', lines=[];
      const m = ctx; words.forEach(w=>{ const t=(line? line+' ':'')+w; if(m.measureText(t).width > radius*1.5){ lines.push(line); line=w; } else line=t; });
      lines.push(line);
      const startY = -((lines.length-1)*lineHeight)/2;
      lines.forEach((ln,i)=>{ ctx.strokeText(ln, radius, startY+i*lineHeight); ctx.fillText(ln, radius, startY+i*lineHeight); });
    }

    function shade(hex, amt){
      const c=hex.replace('#',''); const num=parseInt(c,16);
      let r=(num>>16)+Math.round(255*amt), g=((num>>8)&0xFF)+Math.round(255*amt), b=(num&0xFF)+Math.round(255*amt);
      r=clamp(r,0,255); g=clamp(g,0,255); b=clamp(b,0,255);
      return '#'+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1);
    }

    // ===== Bucle a 60/120/144Hz =====
    let last=performance.now();
    function raf(now){
      const dt=Math.min(0.032,(now-last)/1000); last=now;
      if(spinning){
        angVel = Math.max(0, angVel - angAcc*dt);
        angle += angVel*dt;
        if(angVel===0){ spinning=false; snapToTarget(); onSpinEnd(); }
      }
      drawWheel(angle);
      requestAnimationFrame(raf);
    }

    // ===== SelecciÃ³n con restricciÃ³n de JACKPOT (1% por tirada) y 5s mÃ¡x =====
    function spin(){
      if(spinning || angVel>0) return;
      if(state.tries>=MAX_TRIES){ toast('Has agotado tus 3 intentos.'); return; }

      const n=PRIZES.length, slice=TAU/n;

      // Gate de jackpot 1% (1 de 100 tiradas aprox.)
      const allowJackpot = Math.random() < 0.01;
      do {
        targetIndex = weightedIndex(PRIZES);
      } while(PRIZES[targetIndex].type==='jackpot' && !allowJackpot);

      const current=((angle%TAU)+TAU)%TAU;
      const targetCenter=(n - targetIndex)*slice - slice/2;
      let diff=targetCenter - current; while(diff<0) diff+=TAU;

      const turns = 4 + Math.random()*1.0;   // 4.0â€“5.0 vueltas
      const total = diff + TAU*turns;         // distancia a recorrer
      const T = 3.6 + Math.random()*1.0;     // 3.6â€“4.6s (siempre <5s)
      angVel = (2*total)/T;                  // Ï‰0
      angAcc = angVel / T;                   // desaceleraciÃ³n
      spinning = true; toast(`Intento ${state.tries+1}/${MAX_TRIES}â€¦ Â¡Suerte!`);
    }

    function snapToTarget(){
      const n=PRIZES.length; const slice=TAU/n; const targetCenter=(n - targetIndex)*slice - slice/2; const current=((angle%TAU)+TAU)%TAU; angle += (targetCenter - current);
    }

    function onSpinEnd(){
      const n=PRIZES.length; const slice=TAU/n; const current=((angle%TAU)+TAU)%TAU; const hit=Math.floor(((TAU - current)/slice)%n);
      const p = PRIZES[hit];
      const tier = tierOf(p);

      state.tries++;
      if(tier > state.bestTier){ state.bestTier = tier; state.bestText = p.label; }
      persist();
      updateTries();
      confetti(tier);

      if(state.tries>=MAX_TRIES || tier>=3){ // si ya no hay intentos o ganÃ³ algo grande, mostrar popup final
        openWin(`Te llevas: ${state.bestText || p.label}`);
      } else {
        toast(`Resultado: ${p.label}`);
      }
    }

    function persist(){ localStorage.setItem(storeKey, JSON.stringify(state)); }
    function updateTries(){ document.getElementById('tries').textContent = `Intento ${Math.min(state.tries+1,MAX_TRIES)}/${MAX_TRIES}`; }

    // ===== FX: confeti (mÃ¡s intenso segÃºn tier) =====
    function confetti(tier){
      fx.width=innerWidth; fx.height=innerHeight;
      const base = 150 + tier*60;
      const P=Array.from({length:base},()=>({x:innerWidth/2,y:innerHeight*0.15,r:2+Math.random()*3,vx:(Math.random()-.5)*(6+tier*2),vy:-8 - Math.random()*(4+tier),g:0.22+Math.random()*0.08,a:1}));
      let frames=0; (function loop(){ fctx.clearRect(0,0,fx.width,fx.height); P.forEach(p=>{p.vy+=p.g;p.x+=p.vx;p.y+=p.vy;p.a-=0.012; fctx.globalAlpha=Math.max(0,p.a); fctx.beginPath(); fctx.arc(p.x,p.y,p.r,0,TAU); fctx.fillStyle=`hsl(${(p.x+p.y)%360} 85% 60%)`; fctx.fill();}); if(frames++<160) requestAnimationFrame(loop);})();
    }

    // Modal FELICIDADES
    const modal = document.getElementById('winModal');
    const winText = document.getElementById('winText');
    document.getElementById('closeWin').addEventListener('click', ()=>{ modal.style.display='none'; });
    function openWin(txt){ winText.textContent = txt; modal.style.display='flex'; }

    // UI
    document.getElementById('spin').addEventListener('click', spin);
    window.addEventListener('resize', ()=>{fx.width=innerWidth;fx.height=innerHeight});
    const tEl=document.getElementById('toast'); let tTimer=null; function toast(msg){clearTimeout(tTimer); tEl.textContent=msg; tEl.style.display='block'; tTimer=setTimeout(()=>tEl.style.display='none',2200)}

    // init
    updateTries();
    drawWheel(angle); requestAnimationFrame(raf);
  </script>
</body>
</html>
